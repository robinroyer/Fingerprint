<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FINGERPRINT // SCAN</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #020408;
    --panel: #040d14;
    --border: #0a3a52;
    --accent: #00d4ff;
    --accent2: #ff3c6e;
    --accent3: #00ff9d;
    --text: #8ab4c4;
    --text-bright: #cce8f4;
    --dim: #2a4a5a;
    --warn: #ffaa00;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: repeating-linear-gradient(
      0deg,
      transparent,
      transparent 2px,
      rgba(0,0,0,0.08) 2px,
      rgba(0,0,0,0.08) 4px
    );
    pointer-events: none;
    z-index: 9999;
  }

  /* Grid background */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  #app {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  /* Header */
  header {
    border-bottom: 1px solid var(--border);
    padding-bottom: 20px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 20px;
  }

  .logo {
    font-family: 'Orbitron', monospace;
    font-size: 28px;
    font-weight: 900;
    color: var(--accent);
    text-shadow: 0 0 20px rgba(0,212,255,0.5);
    letter-spacing: 4px;
    animation: flicker 6s infinite;
  }

  .logo span { color: var(--accent2); }

  @keyframes flicker {
    0%,96%,98%,100% { opacity: 1; }
    97% { opacity: 0.8; }
    99% { opacity: 0.9; }
  }

  .header-meta {
    flex: 1;
    text-align: right;
  }

  .header-meta .timestamp {
    color: var(--accent3);
    font-size: 11px;
  }

  /* Status bar */
  #status-bar {
    background: var(--panel);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent);
    padding: 10px 16px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 12px;
  }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent3);
    box-shadow: 0 0 8px var(--accent3);
    animation: pulse 1.5s ease-in-out infinite;
    flex-shrink: 0;
  }

  @keyframes pulse {
    0%,100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  #status-text { color: var(--text-bright); flex: 1; }
  #progress-pct { color: var(--accent); font-weight: bold; margin-left: auto; }

  /* Progress bar */
  #progress-wrap {
    background: var(--panel);
    border: 1px solid var(--border);
    height: 4px;
    margin-bottom: 28px;
    overflow: hidden;
  }

  #progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent3));
    width: 0%;
    transition: width 0.3s ease;
    box-shadow: 0 0 12px var(--accent);
  }

  /* Section grid */
  .sections-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    gap: 16px;
    margin-bottom: 30px;
  }

  .section {
    background: var(--panel);
    border: 1px solid var(--border);
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s ease, transform 0.4s ease, border-color 0.3s;
  }

  .section.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .section:hover {
    border-color: rgba(0,212,255,0.3);
  }

  .section-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    font-weight: 700;
    text-transform: uppercase;
  }

  .section-icon { font-size: 14px; }
  .section-title { color: var(--accent); }
  .section-status {
    margin-left: auto;
    font-size: 9px;
    letter-spacing: 1px;
  }
  .section-status.scanning { color: var(--warn); animation: blink 1s infinite; }
  .section-status.done { color: var(--accent3); }
  .section-status.error { color: var(--accent2); }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .section-body { padding: 12px 14px; }

  .data-row {
    display: flex;
    gap: 8px;
    padding: 4px 0;
    border-bottom: 1px solid rgba(10,58,82,0.4);
    align-items: flex-start;
    font-size: 12px;
  }

  .data-row:last-child { border-bottom: none; }

  .data-key {
    color: var(--dim);
    min-width: 140px;
    flex-shrink: 0;
    font-size: 11px;
  }

  .data-val {
    color: var(--text-bright);
    word-break: break-all;
    flex: 1;
  }

  .data-val.highlight { color: var(--accent3); }
  .data-val.warn { color: var(--warn); }
  .data-val.danger { color: var(--accent2); }
  .data-val.loading { color: var(--dim); font-style: italic; animation: blink 1s infinite; }

  /* Canvas fingerprint display */
  #canvas-fp-preview {
    border: 1px solid var(--border);
    margin: 8px 0;
    width: 100%;
    height: 40px;
    display: block;
  }

  /* Network latency bar */
  .latency-bar {
    height: 6px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 4px;
    width: 100%;
  }

  .latency-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.8s ease;
  }

  /* Summary table */
  #summary {
    margin-top: 30px;
    border: 1px solid var(--border);
    border-top: 2px solid var(--accent);
  }

  #summary-header {
    padding: 14px 18px;
    background: rgba(0,212,255,0.06);
    border-bottom: 1px solid var(--border);
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    letter-spacing: 3px;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 12px;
  }

  #fingerprint-hash {
    margin-left: auto;
    font-size: 11px;
    color: var(--accent3);
    letter-spacing: 1px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }

  th {
    text-align: left;
    padding: 8px 18px;
    font-family: 'Orbitron', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--accent);
    border-bottom: 1px solid var(--border);
    background: rgba(0,212,255,0.03);
  }

  td {
    padding: 7px 18px;
    border-bottom: 1px solid rgba(10,58,82,0.3);
    vertical-align: top;
  }

  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(0,212,255,0.03); }

  td:nth-child(1) { color: var(--dim); font-size: 11px; width: 200px; }
  td:nth-child(2) { color: var(--text-bright); word-break: break-all; }
  td:nth-child(3) {
    width: 100px;
    text-align: center;
    font-size: 10px;
    font-family: 'Orbitron', monospace;
    letter-spacing: 1px;
  }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    font-size: 9px;
    border-radius: 2px;
    letter-spacing: 1px;
  }

  .badge-ok { background: rgba(0,255,157,0.12); color: var(--accent3); border: 1px solid rgba(0,255,157,0.2); }
  .badge-warn { background: rgba(255,170,0,0.12); color: var(--warn); border: 1px solid rgba(255,170,0,0.2); }
  .badge-hi { background: rgba(255,60,110,0.12); color: var(--accent2); border: 1px solid rgba(255,60,110,0.2); }
  .badge-na { background: rgba(42,74,90,0.3); color: var(--dim); border: 1px solid var(--border); }

  .risk-score {
    font-family: 'Orbitron', monospace;
    font-size: 32px;
    font-weight: 900;
    text-align: center;
    padding: 20px;
    border-top: 1px solid var(--border);
  }

  footer {
    margin-top: 30px;
    padding: 16px 0;
    border-top: 1px solid var(--border);
    font-size: 10px;
    color: var(--dim);
    display: flex;
    justify-content: space-between;
    letter-spacing: 1px;
  }
</style>
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</head>
<body>
<div id="app">
  <header>
    <div>
      <div class="logo">FINGER<span>PRINT</span></div>
    </div>
    <div class="header-meta">
      <div class="timestamp" id="ts"></div>
      <div style="font-size:10px;color:var(--dim);margin-top:4px">SESSION INITIATED</div>
    </div>
  </header>

  <div id="status-bar">
    <div class="status-dot"></div>
    <div id="status-text">Initializing scan modules...</div>
    <div id="progress-pct">0%</div>
  </div>
  <div id="progress-wrap"><div id="progress-bar"></div></div>

  <div class="sections-grid" id="sections-grid"></div>

  <div id="summary" style="display:none">
    <div id="summary-header">
      ‚óà COMPLETE FINGERPRINT SUMMARY
      <span id="fingerprint-hash"></span>
    </div>
    <table id="summary-table">
      <thead>
        <tr>
          <th>VECTOR</th>
          <th>VALUE</th>
          <th>RISK</th>
        </tr>
      </thead>
      <tbody id="summary-body"></tbody>
    </table>
    <div class="risk-score" id="risk-score"></div>
  </div>

  <footer>
    <span>‚ö† EDUCATIONAL PURPOSE ONLY ‚Äî ALL DATA PROCESSED LOCALLY ‚Äî NO TRANSMISSION</span>
    <span id="scan-duration"></span>
  </footer>
</div>

<script>
const startTime = Date.now();
let collected = {};
let totalSteps = 0;
let completedSteps = 0;

// ‚îÄ‚îÄ‚îÄ Behavioral data ‚Äî start collecting immediately ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _behaviorStart = Date.now();
const _behaviorData = { firstInteraction: null, modality: null, mousePoints: [], scrollEvents: [] };
(function setupBehaviorListeners() {
  function onFirst(type) {
    if (!_behaviorData.firstInteraction) {
      _behaviorData.firstInteraction = Date.now() - _behaviorStart;
      _behaviorData.modality = type;
    }
  }
  window.addEventListener('mousemove', e => {
    onFirst('mouse');
    if (_behaviorData.mousePoints.length < 20)
      _behaviorData.mousePoints.push({ x: e.clientX, y: e.clientY, t: Date.now() - _behaviorStart });
  }, { passive: true });
  window.addEventListener('touchstart', () => onFirst('touch'), { passive: true });
  window.addEventListener('keydown', () => onFirst('keyboard'), { passive: true });
  window.addEventListener('scroll', () => {
    onFirst('scroll');
    if (_behaviorData.scrollEvents.length < 5)
      _behaviorData.scrollEvents.push({ y: window.scrollY, t: Date.now() - _behaviorStart });
  }, { passive: true });
})();

// Timestamp
function updateClock() {
  document.getElementById('ts').textContent = new Date().toISOString().replace('T',' ').split('.')[0] + ' UTC';
}
setInterval(updateClock, 1000);
updateClock();

function setStatus(msg) {
  document.getElementById('status-text').textContent = msg;
}

function setProgress(pct) {
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('progress-pct').textContent = Math.round(pct) + '%';
}

// ‚îÄ‚îÄ‚îÄ Section builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createSection(id, icon, title) {
  const grid = document.getElementById('sections-grid');
  const sec = document.createElement('div');
  sec.className = 'section';
  sec.id = 'sec-' + id;
  sec.innerHTML = `
    <div class="section-header">
      <span class="section-icon">${icon}</span>
      <span class="section-title">${title}</span>
      <span class="section-status scanning" id="status-${id}">SCANNING</span>
    </div>
    <div class="section-body" id="body-${id}"></div>
  `;
  grid.appendChild(sec);
  requestAnimationFrame(() => { sec.classList.add('visible'); });
  return sec;
}

function row(key, val, cls = '') {
  return `<div class="data-row"><span class="data-key">${key}</span><span class="data-val ${cls}">${val || '<span class="loading">probing...</span>'}</span></div>`;
}

function setBody(id, html) {
  document.getElementById('body-' + id).innerHTML = html;
}

function markDone(id, ok = true) {
  const el = document.getElementById('status-' + id);
  if (el) {
    el.className = 'section-status ' + (ok ? 'done' : 'error');
    el.textContent = ok ? 'DONE' : 'PARTIAL';
  }
  completedSteps++;
  setProgress((completedSteps / totalSteps) * 100);
}

// ‚îÄ‚îÄ‚îÄ Collectors ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function collectBrowser() {
  createSection('browser', 'üåê', 'BROWSER IDENTITY');
  setStatus('Fingerprinting browser...');

  const ua = navigator.userAgent;
  const uaData = navigator.userAgentData;

  // Parse UA
  let browser = 'Unknown', version = 'Unknown', engine = 'Unknown';
  const chromeM = ua.match(/Chrome\/([\d.]+)/);
  const ffM = ua.match(/Firefox\/([\d.]+)/);
  const safariM = ua.match(/Version\/([\d.]+).*Safari/);
  const edgeM = ua.match(/Edg\/([\d.]+)/);
  if (edgeM) { browser = 'Edge'; version = edgeM[1]; engine = 'Blink'; }
  else if (chromeM) { browser = 'Chrome'; version = chromeM[1]; engine = 'Blink'; }
  else if (ffM) { browser = 'Firefox'; version = ffM[1]; engine = 'Gecko'; }
  else if (safariM) { browser = 'Safari'; version = safariM[1]; engine = 'WebKit'; }

  let brands = 'N/A';
  if (uaData && uaData.brands) {
    brands = uaData.brands.map(b => `${b.brand} ${b.version}`).join(' ¬∑ ');
  }

  let highEntropy = {};
  try {
    if (uaData) highEntropy = await uaData.getHighEntropyValues([
      'architecture','model','platform','platformVersion','fullVersionList','uaFullVersion'
    ]);
  } catch(e) {}

  const plugins = Array.from(navigator.plugins || []).map(p => p.name).join(', ') || 'None / Hidden';

  collected.browser = { browser, version, engine, ua };

  setBody('browser', [
    row('Browser', `<span class="highlight">${browser} ${version}</span>`),
    row('Engine', engine),
    row('UA Brands', brands),
    row('Platform', highEntropy.platform || navigator.platform),
    row('Platform Version', highEntropy.platformVersion || 'N/A'),
    row('Architecture', highEntropy.architecture || 'N/A'),
    row('Model', highEntropy.model || 'N/A'),
    row('Mobile', (uaData?.mobile ?? /Mobi/.test(ua)).toString()),
    row('Plugins', plugins.substring(0, 120)),
    row('Cookies Enabled', navigator.cookieEnabled.toString(), navigator.cookieEnabled ? 'highlight' : 'warn'),
    row('Java Enabled', (navigator.javaEnabled?.() ?? false).toString()),
    row('Do Not Track', navigator.doNotTrack || 'Not set', navigator.doNotTrack === '1' ? 'highlight' : ''),
    row('PDF Viewer', (!!navigator.pdfViewerEnabled).toString()),
  ].join(''));
  markDone('browser');
}

function collectScreen() {
  createSection('screen', 'üñ•Ô∏è', 'DISPLAY & SCREEN');
  setStatus('Analyzing display...');

  const s = screen;
  const dpr = window.devicePixelRatio;
  const physW = Math.round(s.width * dpr);
  const physH = Math.round(s.height * dpr);
  const diag = Math.round(Math.sqrt(physW*physW + physH*physH));
  const orient = screen.orientation?.type || (window.innerWidth > window.innerHeight ? 'landscape' : 'portrait');
  const colorGamut = window.matchMedia('(color-gamut: p3)').matches ? 'P3' :
                     window.matchMedia('(color-gamut: srgb)').matches ? 'sRGB' : 'Limited';
  const hdr = window.matchMedia('(dynamic-range: high)').matches;
  const prefScheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'Dark' : 'Light';
  const prefMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'Reduced' : 'Full';
  const prefContrast = window.matchMedia('(prefers-contrast: more)').matches ? 'High' : 'Normal';

  collected.screen = { width: s.width, height: s.height, dpr, colorDepth: s.colorDepth };

  setBody('screen', [
    row('Logical Resolution', `<span class="highlight">${s.width} √ó ${s.height}</span>`),
    row('Physical Resolution', `${physW} √ó ${physH} (${diag}px diagonal)`),
    row('Available Space', `${s.availWidth} √ó ${s.availHeight}`),
    row('Viewport', `${window.innerWidth} √ó ${window.innerHeight}`),
    row('Outer Window', `${window.outerWidth} √ó ${window.outerHeight}`),
    row('Device Pixel Ratio', `${dpr}x`, dpr > 1 ? 'highlight' : ''),
    row('Color Depth', `${s.colorDepth}-bit`),
    row('Color Gamut', colorGamut),
    row('HDR Support', hdr.toString()),
    row('Orientation', orient),
    row('Color Scheme Pref', prefScheme),
    row('Motion Pref', prefMotion),
    row('Contrast Pref', prefContrast),
  ].join(''));
  markDone('screen');
}

function collectHardware() {
  createSection('hw', 'üíª', 'HARDWARE SIGNALS');
  setStatus('Probing hardware...');

  const cores = navigator.hardwareConcurrency || 'N/A';
  const mem = navigator.deviceMemory || 'N/A';
  const touch = navigator.maxTouchPoints;
  const hasTouch = touch > 0;
  const pointer = window.matchMedia('(pointer: fine)').matches ? 'Fine (Mouse)' :
                  window.matchMedia('(pointer: coarse)').matches ? 'Coarse (Touch)' : 'None';
  const hover = window.matchMedia('(hover: hover)').matches ? 'Yes' : 'No';

  // WebGL GPU info
  let gpu = 'N/A', glVendor = 'N/A', glVersion = 'N/A', glSL = 'N/A';
  let maxTexSize = 'N/A', maxViewport = 'N/A';
  try {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    if (gl) {
      const ext = gl.getExtension('WEBGL_debug_renderer_info');
      if (ext) {
        gpu = gl.getParameter(ext.UNMASKED_RENDERER_WEBGL);
        glVendor = gl.getParameter(ext.UNMASKED_VENDOR_WEBGL);
      }
      glVersion = gl.getParameter(gl.VERSION);
      glSL = gl.getParameter(gl.SHADING_LANGUAGE_VERSION);
      maxTexSize = gl.getParameter(gl.MAX_TEXTURE_SIZE);
      const vp = gl.getParameter(gl.MAX_VIEWPORT_DIMS);
      maxViewport = vp ? `${vp[0]} √ó ${vp[1]}` : 'N/A';
    }
  } catch(e) {}

  // WebGL2
  let gl2 = false;
  try { gl2 = !!document.createElement('canvas').getContext('webgl2'); } catch(e) {}

  collected.hw = { cores, mem, gpu, touch };

  setBody('hw', [
    row('CPU Logical Cores', `<span class="highlight">${cores}</span>`),
    row('Device Memory', mem !== 'N/A' ? `${mem} GB (rounded)` : 'N/A (API blocked)'),
    row('Touch Points', `${touch} (${hasTouch ? 'touch capable' : 'no touch'})`),
    row('Primary Pointer', pointer),
    row('Hover Capable', hover),
    row('GPU Renderer', gpu.substring(0, 60), 'highlight'),
    row('GPU Vendor', glVendor),
    row('WebGL Version', glVersion),
    row('GLSL Version', glSL),
    row('WebGL2', gl2.toString()),
    row('Max Texture Size', maxTexSize.toString()),
    row('Max Viewport', maxViewport),
  ].join(''));
  markDone('hw');
}

function collectLocale() {
  createSection('locale', 'üåç', 'LOCALE & TIMEZONE');
  setStatus('Detecting locale...');

  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
  const tzOffset = -new Date().getTimezoneOffset();
  const locale = navigator.language;
  const locales = navigator.languages?.join(', ') || locale;

  // DST detection
  const jan = new Date(2024,0,1).getTimezoneOffset();
  const jul = new Date(2024,6,1).getTimezoneOffset();
  const hasDST = jan !== jul;

  // Number/currency format
  const numFmt = new Intl.NumberFormat().format(1234567.89);
  const curFmt = (() => { try { return new Intl.NumberFormat(locale, {style:'currency',currency:'EUR'}).format(1234.5); } catch(e) { return 'N/A'; } })();
  const dateFmt = new Intl.DateTimeFormat(locale).format(new Date());
  const hour12 = new Intl.DateTimeFormat(locale,{hour:'numeric'}).resolvedOptions().hour12;

  collected.locale = { tz, locale, locales };

  setBody('locale', [
    row('Timezone', `<span class="highlight">${tz}</span>`),
    row('UTC Offset', `${tzOffset >= 0 ? '+' : ''}${Math.floor(tzOffset/60)}:${String(Math.abs(tzOffset%60)).padStart(2,'0')}`),
    row('DST Active', hasDST.toString()),
    row('Primary Language', locale),
    row('All Languages', locales),
    row('Number Format', numFmt),
    row('Currency Format', curFmt),
    row('Date Format', dateFmt),
    row('12-Hour Clock', hour12?.toString() || 'N/A'),
  ].join(''));
  markDone('locale');
}

async function collectNetwork() {
  createSection('net', 'üì°', 'NETWORK TOPOLOGY');
  setStatus('Analyzing network...');

  const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  const connType = conn?.type || 'N/A';
  const effType = conn?.effectiveType || 'N/A';
  const downlink = conn?.downlink || 'N/A';
  const rtt = conn?.rtt || 'N/A';
  const saveData = conn?.saveData || false;

  // Latency probes
  const probeUrls = [
    { label: 'DNS (google.com img)', url: 'https://www.google.com/favicon.ico' },
    { label: 'CDN (cloudflare)', url: 'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js' },
  ];

  const latencies = [];
  for (const probe of probeUrls) {
    try {
      const t0 = performance.now();
      await fetch(probe.url + '?t=' + Date.now(), { mode: 'no-cors', cache: 'no-store' });
      const lat = Math.round(performance.now() - t0);
      latencies.push({ label: probe.label, lat });
    } catch(e) {
      latencies.push({ label: probe.label, lat: null });
    }
  }

  // WebRTC local IP leak
  let localIPs = [];
  try {
    await new Promise((resolve) => {
      const pc = new RTCPeerConnection({ iceServers: [] });
      pc.createDataChannel('');
      pc.onicecandidate = e => {
        if (!e || !e.candidate) { pc.close(); resolve(); return; }
        const m = e.candidate.candidate.match(/(\d+\.\d+\.\d+\.\d+)/g);
        if (m) m.forEach(ip => { if (!localIPs.includes(ip)) localIPs.push(ip); });
      };
      pc.createOffer().then(o => pc.setLocalDescription(o));
      setTimeout(resolve, 2000);
    });
  } catch(e) {}

  const latRows = latencies.map(l => {
    if (l.lat === null) return row(l.label, 'Failed', 'danger');
    const color = l.lat < 100 ? 'highlight' : l.lat < 300 ? 'warn' : 'danger';
    const barWidth = Math.min(100, (l.lat / 500) * 100);
    const barColor = l.lat < 100 ? 'var(--accent3)' : l.lat < 300 ? 'var(--warn)' : 'var(--accent2)';
    return `<div class="data-row">
      <span class="data-key">${l.label}</span>
      <span class="data-val ${color}">
        ${l.lat}ms
        <div class="latency-bar"><div class="latency-fill" style="width:${barWidth}%;background:${barColor}"></div></div>
      </span>
    </div>`;
  }).join('');

  collected.network = { connType, effType, downlink, rtt, localIPs };

  setBody('net', [
    row('Connection Type', connType),
    row('Effective Type', `<span class="highlight">${effType}</span>`),
    row('Est. Downlink', downlink !== 'N/A' ? `${downlink} Mbps` : 'N/A'),
    row('RTT Hint', rtt !== 'N/A' ? `${rtt}ms` : 'N/A'),
    row('Data Saver', saveData.toString()),
    row('WebRTC Local IPs', localIPs.length ? `<span class="danger">${localIPs.join(', ')}</span>` : 'Not leaked'),
    latRows,
  ].join(''));
  markDone('net');
}

async function collectPerformance() {
  createSection('perf', '‚ö°', 'PERFORMANCE SIGNALS');
  setStatus('Running performance probes...');

  // Navigation timing
  const nav = performance.getEntriesByType('navigation')[0] || {};
  const loadTime = nav.loadEventEnd ? Math.round(nav.loadEventEnd - nav.startTime) : 'N/A';
  const dnsTime = nav.domainLookupEnd ? Math.round(nav.domainLookupEnd - nav.domainLookupStart) : 'N/A';
  const tcpTime = nav.connectEnd ? Math.round(nav.connectEnd - nav.connectStart) : 'N/A';

  // Memory
  const mem = performance.memory;
  const heapUsed = mem ? Math.round(mem.usedJSHeapSize / 1048576) : null;
  const heapTotal = mem ? Math.round(mem.totalJSHeapSize / 1048576) : null;
  const heapLimit = mem ? Math.round(mem.jsHeapSizeLimit / 1048576) : null;

  // CPU benchmark
  const t0 = performance.now();
  let sum = 0;
  for (let i = 0; i < 1000000; i++) sum += Math.sqrt(i);
  const cpuTime = Math.round(performance.now() - t0);

  // Math perf
  const t1 = performance.now();
  for (let i = 0; i < 100000; i++) Math.sin(i) * Math.cos(i);
  const mathTime = Math.round(performance.now() - t1);

  collected.perf = { heapUsed, heapTotal, cpuTime };

  setBody('perf', [
    row('Page Load Time', loadTime !== 'N/A' ? `${loadTime}ms` : 'N/A'),
    row('DNS Resolve', dnsTime !== 'N/A' ? `${dnsTime}ms` : 'N/A'),
    row('TCP Connect', tcpTime !== 'N/A' ? `${tcpTime}ms` : 'N/A'),
    row('JS Heap Used', heapUsed ? `${heapUsed} MB` : 'N/A (Firefox)'),
    row('JS Heap Total', heapTotal ? `${heapTotal} MB` : 'N/A'),
    row('JS Heap Limit', heapLimit ? `${heapLimit} MB` : 'N/A'),
    row('CPU Bench (1M ‚àö)', `${cpuTime}ms`, cpuTime < 10 ? 'highlight' : cpuTime < 50 ? '' : 'warn'),
    row('Math Bench (100K)', `${mathTime}ms`),
    row('Timing Resolution', `${performance.now().toString().split('.')[1]?.length || 0} decimals`),
  ].join(''));
  markDone('perf');
}

function collectStorage() {
  createSection('storage', 'üíæ', 'STORAGE & PRIVACY');
  setStatus('Testing storage APIs...');

  const checks = {
    'localStorage': () => { localStorage.setItem('_fp','1'); localStorage.removeItem('_fp'); return true; },
    'sessionStorage': () => { sessionStorage.setItem('_fp','1'); sessionStorage.removeItem('_fp'); return true; },
    'IndexedDB': () => !!window.indexedDB,
    'WebSQL': () => !!window.openDatabase,
    'Cookies': () => navigator.cookieEnabled,
    'Cache API': () => !!window.caches,
    'Service Workers': () => 'serviceWorker' in navigator,
    'SharedArrayBuffer': () => typeof SharedArrayBuffer !== 'undefined',
    'Atomics': () => typeof Atomics !== 'undefined',
  };

  const rows = Object.entries(checks).map(([key, fn]) => {
    let val, cls;
    try { val = fn() ? '‚úì Available' : '‚úó Blocked'; cls = fn() ? 'highlight' : 'warn'; }
    catch(e) { val = '‚úó Blocked'; cls = 'warn'; }
    return row(key, val, cls);
  });

  // Storage quota
  let quota = '';
  navigator.storage?.estimate?.().then(est => {
    const used = Math.round(est.usage / 1048576);
    const total = Math.round(est.quota / 1048576);
    document.getElementById('body-storage').innerHTML += row('Storage Quota', `${used}MB used / ${total}MB total`);
  }).catch(() => {});

  collected.storage = { cookies: navigator.cookieEnabled };

  setBody('storage', rows.join('') + row('Storage Quota', '<span class="loading">estimating...</span>'));
  markDone('storage');
}

async function collectCanvas() {
  createSection('canvas', 'üé®', 'CANVAS FINGERPRINT');
  setStatus('Generating canvas fingerprint...');

  const canvas = document.createElement('canvas');
  canvas.width = 280; canvas.height = 40;
  const ctx = canvas.getContext('2d');

  ctx.textBaseline = 'top';
  ctx.fillStyle = '#f60';
  ctx.fillRect(125, 1, 62, 20);
  ctx.fillStyle = '#069';
  ctx.font = '11pt "Arial"';
  ctx.fillText('FP: Cwm fjordbank glyphs vext quiz', 2, 1);
  ctx.fillStyle = 'rgba(102,204,0,0.7)';
  ctx.font = '18pt "Times New Roman"';
  ctx.fillText('Cwm fjordbank', 4, 17);
  ctx.strokeStyle = '#ff2d55';
  ctx.beginPath(); ctx.arc(50, 50, 50, 0, Math.PI * 2, true); ctx.stroke();

  const dataURL = canvas.toDataURL();
  const hash = await simpleHash(dataURL);

  // Show preview
  const preview = document.createElement('canvas');
  preview.id = 'canvas-fp-preview';
  preview.width = 280; preview.height = 40;
  const pctx = preview.getContext('2d');
  pctx.drawImage(canvas, 0, 0);

  setBody('canvas', `
    <div class="data-row"><span class="data-key">Render</span><span class="data-val">
      <canvas id="canvas-fp-preview" width="280" height="40" style="border:1px solid var(--border);margin:4px 0;display:block;width:100%;max-width:280px"></canvas>
    </span></div>
    ${row('Fingerprint Hash', `<span class="highlight">${hash}</span>`)}
    ${row('Data URL Length', dataURL.length + ' chars')}
    ${row('toDataURL Method', 'image/png')}
  `);
  const cv = document.getElementById('canvas-fp-preview');
  if (cv) { const c = cv.getContext('2d'); c.drawImage(canvas, 0, 0); }

  collected.canvas = { hash };
  markDone('canvas');
}

async function collectAudio() {
  createSection('audio', 'üîä', 'AUDIO FINGERPRINT');
  setStatus('Sampling audio context...');

  let audioFP = 'N/A', sampleRate = 'N/A', channelCount = 'N/A', state = 'N/A';
  let baseLatency = 'N/A', outputLatency = 'N/A';

  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    sampleRate = ctx.sampleRate;
    state = ctx.state;
    baseLatency = ctx.baseLatency ? ctx.baseLatency.toFixed(6) : 'N/A';
    outputLatency = ctx.outputLatency ? ctx.outputLatency.toFixed(6) : 'N/A';

    const oscillator = ctx.createOscillator();
    const compressor = ctx.createDynamicsCompressor();
    compressor.threshold.value = -50;
    compressor.knee.value = 40;
    compressor.ratio.value = 12;
    compressor.attack.value = 0;
    compressor.release.value = 0.25;

    oscillator.type = 'triangle';
    oscillator.frequency.value = 10000;
    oscillator.connect(compressor);
    const dest = ctx.createMediaStreamDestination();
    compressor.connect(dest);
    oscillator.start(0);

    const analyser = ctx.createAnalyser();
    compressor.connect(analyser);
    analyser.connect(ctx.destination);
    analyser.fftSize = 1024;
    const data = new Float32Array(analyser.frequencyBinCount);
    analyser.getFloatFrequencyData(data);
    audioFP = await simpleHash(data.slice(0, 50).join(','));

    oscillator.stop();
    ctx.close();
  } catch(e) {
    audioFP = 'Blocked: ' + e.message.substring(0, 30);
  }

  collected.audio = { audioFP, sampleRate };

  setBody('audio', [
    row('Audio Fingerprint', `<span class="highlight">${audioFP}</span>`),
    row('Sample Rate', sampleRate + ' Hz'),
    row('Context State', state),
    row('Base Latency', baseLatency !== 'N/A' ? baseLatency + 's' : 'N/A'),
    row('Output Latency', outputLatency !== 'N/A' ? outputLatency + 's' : 'N/A'),
  ].join(''));
  markDone('audio');
}

function collectFonts() {
  createSection('fonts', 'üî§', 'FONT DETECTION');
  setStatus('Detecting installed fonts...');

  const testFonts = [
    'Arial','Helvetica','Times New Roman','Courier New','Verdana','Georgia','Palatino',
    'Garamond','Bookman','Comic Sans MS','Trebuchet MS','Arial Black','Impact',
    'Tahoma','Geneva','Lucida Sans','Lucida Console','Symbol','Webdings','Wingdings',
    'MS Gothic','MS PGothic','Meiryo','Hiragino Sans',
    'Apple Chancery','Apple Color Emoji','Menlo','Monaco',
    'Consolas','Calibri','Cambria','Segoe UI','Segoe Print',
    'Ubuntu','DejaVu Sans','Liberation Sans','Roboto','Open Sans',
    'Noto Sans','Lato','Montserrat','Raleway','Oswald',
    'Fira Code','JetBrains Mono','Hack','Source Code Pro',
    '.SF NS Text','San Francisco',
  ];

  const baseFont = 'monospace';
  const testStr = 'mmmmmmmmmmlli';
  const testSize = '72px';
  const span = document.createElement('span');
  span.style.cssText = `font-size:${testSize};position:absolute;left:-9999px;visibility:hidden;`;
  span.textContent = testStr;
  document.body.appendChild(span);

  span.style.fontFamily = baseFont;
  const baseW = span.offsetWidth;
  const baseH = span.offsetHeight;

  const detected = [];
  for (const font of testFonts) {
    span.style.fontFamily = `"${font}", ${baseFont}`;
    if (span.offsetWidth !== baseW || span.offsetHeight !== baseH) detected.push(font);
  }
  document.body.removeChild(span);

  collected.fonts = { detected, count: detected.length };

  setBody('fonts', [
    row('Detected Count', `<span class="highlight">${detected.length} / ${testFonts.length}</span>`),
    row('Detected Fonts', detected.join(', ') || 'None'),
  ].join(''));
  markDone('fonts');
}

async function collectPermissions() {
  createSection('perms', 'üîê', 'PERMISSIONS & APIS');
  setStatus('Querying browser permissions...');

  const permList = [
    'geolocation','notifications','camera','microphone',
    'persistent-storage','clipboard-read','clipboard-write',
    'payment-handler',
  ];

  const rows = [];
  for (const perm of permList) {
    try {
      const result = await navigator.permissions.query({ name: perm });
      const cls = result.state === 'granted' ? 'danger' : result.state === 'prompt' ? 'warn' : 'highlight';
      rows.push(row(perm, `<span class="${cls}">${result.state.toUpperCase()}</span>`));
    } catch(e) {
      rows.push(row(perm, '<span class="dim">N/A</span>'));
    }
  }

  // API availability checks
  const apis = {
    'Bluetooth API': () => !!navigator.bluetooth,
    'USB API': () => !!navigator.usb,
    'Serial API': () => !!navigator.serial,
    'HID API': () => !!navigator.hid,
    'Gamepad API': () => !!navigator.getGamepads,
    'Battery API': () => !!navigator.getBattery,
    'Credential Mgmt': () => !!navigator.credentials,
    'Payment Request': () => !!window.PaymentRequest,
    'WebXR': () => !!navigator.xr,
    'Eye Dropper': () => !!window.EyeDropper,
    'Screen Wake Lock': () => !!navigator.wakeLock,
    'Web NFC': () => !!window.NDEFReader,
    'Web Share': () => !!navigator.share,
    'MediaDevices': () => !!navigator.mediaDevices,
  };

  const apiRows = Object.entries(apis).map(([name, fn]) => {
    try { return row(name, fn() ? '<span class="warn">Available</span>' : '<span class="highlight">N/A</span>'); }
    catch(e) { return row(name, 'N/A'); }
  });

  setBody('perms', [...rows, ...apiRows].join(''));
  markDone('perms');
}

async function collectBattery() {
  createSection('battery', 'üîã', 'BATTERY & SYSTEM');
  setStatus('Reading battery info...');

  let rows = [];
  try {
    const battery = await navigator.getBattery();
    const level = Math.round(battery.level * 100);
    rows = [
      row('Battery Level', `<span class="${level > 50 ? 'highlight' : level > 20 ? 'warn' : 'danger'}">${level}%</span>`),
      row('Charging', battery.charging ? '<span class="highlight">Yes</span>' : '<span class="warn">No</span>'),
      row('Charging Time', battery.chargingTime === Infinity ? 'N/A' : battery.chargingTime + 's'),
      row('Discharging Time', battery.dischargingTime === Infinity ? 'N/A' : Math.round(battery.dischargingTime / 60) + ' min'),
    ];
    collected.battery = { level, charging: battery.charging };
  } catch(e) {
    rows = [row('Battery API', 'Not available or blocked')];
    collected.battery = null;
  }

  // Additional system signals
  rows.push(row('Online Status', navigator.onLine ? '<span class="highlight">Online</span>' : '<span class="danger">Offline</span>'));
  rows.push(row('Concurrent Workers', navigator.hardwareConcurrency || 'N/A'));
  rows.push(row('User Activation', navigator.userActivation?.hasBeenActive ? 'Yes' : 'No'));

  setBody('battery', rows.join(''));
  markDone('battery');
}

async function collectMediaDevices() {
  createSection('media', 'üì∑', 'MEDIA DEVICES');
  setStatus('Enumerating media devices...');

  let rows = [];
  try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const audioIn = devices.filter(d => d.kind === 'audioinput');
    const audioOut = devices.filter(d => d.kind === 'audiooutput');
    const videoIn = devices.filter(d => d.kind === 'videoinput');

    rows = [
      row('Microphones', `${audioIn.length} device(s)`, audioIn.length ? 'warn' : 'highlight'),
      row('Speakers/Headphones', `${audioOut.length} device(s)`),
      row('Cameras', `${videoIn.length} device(s)`, videoIn.length ? 'warn' : 'highlight'),
    ];

    // List them (without labels for privacy ‚Äî labels are empty without permission)
    devices.forEach((d, i) => {
      const label = d.label || `${d.kind} ${i}`;
      rows.push(row(`  Device ${i+1}`, `[${d.kind}] ${label.substring(0,40)}`));
    });

    // Supported codecs
    const types = ['video/webm;codecs=vp9','video/webm;codecs=vp8','video/mp4;codecs=h264','audio/webm;codecs=opus'];
    const codecRows = types.map(t => {
      const sup = MediaRecorder.isTypeSupported(t);
      return row(t.split(';')[0].split('/')[1] + ':' + t.split('codecs=')[1], sup ? '<span class="highlight">‚úì</span>' : '<span class="dim">‚úó</span>');
    });
    rows.push(...codecRows);

    collected.media = { audioIn: audioIn.length, videoIn: videoIn.length };
  } catch(e) {
    rows = [row('Error', e.message)];
    collected.media = null;
  }

  setBody('media', rows.join(''));
  markDone('media');
}

function collectWebRTC() {
  createSection('webrtc', 'üõ∞Ô∏è', 'WEBRTC & PROTOCOLS');
  setStatus('Checking WebRTC capabilities...');

  const pc = window.RTCPeerConnection;
  const capabilities = {
    'RTCPeerConnection': !!pc,
    'RTCDataChannel': !!(pc && RTCPeerConnection.prototype.createDataChannel),
    'getUserMedia': !!(navigator.mediaDevices?.getUserMedia),
    'Screen Capture': !!(navigator.mediaDevices?.getDisplayMedia),
    'WebSocket': !!window.WebSocket,
    'WebTransport': !!window.WebTransport,
    'QUIC/WebTransport': !!window.WebTransport,
    'Fetch API': !!window.fetch,
    'Server-Sent Events': !!window.EventSource,
    'Push API': !!window.PushManager,
    'Broadcast Channel': !!window.BroadcastChannel,
  };

  // STUN servers available
  const stunServers = ['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302'];
  const rows = Object.entries(capabilities).map(([k,v]) =>
    row(k, v ? '<span class="highlight">‚úì</span>' : '<span class="dim">‚úó</span>')
  );

  // TLS/HTTP version hint
  const proto = window.location.protocol;
  rows.unshift(row('Page Protocol', proto === 'https:' ? '<span class="highlight">HTTPS</span>' : '<span class="danger">HTTP</span>'));
  rows.push(row('HTTP/2 Support', 'Via performance.timing API'));

  collected.webrtc = { supported: !!pc };
  setBody('webrtc', rows.join(''));
  markDone('webrtc');
}

// ‚îÄ‚îÄ‚îÄ NEW MODULES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function collectVoices() {
  createSection('voices', 'üó£Ô∏è', 'SPEECH SYNTHESIS VOICES');
  setStatus('Enumerating speech voices...');
  let voices = [];
  try {
    voices = speechSynthesis.getVoices();
    if (voices.length === 0) {
      await new Promise(resolve => {
        speechSynthesis.onvoiceschanged = resolve;
        setTimeout(resolve, 500);
      });
      voices = speechSynthesis.getVoices();
    }
  } catch(e) {}
  const count = voices.length;
  const langs = [...new Set(voices.map(v => v.lang))].sort();
  const defaultVoice = voices.find(v => v.default);
  const localCount = voices.filter(v => v.localService).length;
  const voiceListStr = voices.map(v => `${v.name}|${v.lang}|${v.localService}`).join(';');
  const hash = count ? await simpleHash(voiceListStr) : 'N/A';
  const first10 = voices.slice(0, 10).map(v =>
    `<div style="font-size:11px;color:var(--text);padding:1px 0">${v.name} <span style="color:var(--dim)">[${v.lang}${v.localService ? ' LOCAL' : ''}${v.default ? ' DEFAULT' : ''}]</span></div>`
  ).join('');
  collected.voices = { count, hash, langs: langs.length };
  setBody('voices', [
    row('Total Voices', `<span class="highlight">${count}</span>`),
    row('Unique Languages', langs.length.toString()),
    row('Local Service', localCount.toString()),
    row('Remote', (count - localCount).toString()),
    row('Default Voice', defaultVoice ? `${defaultVoice.name} [${defaultVoice.lang}]` : 'N/A'),
    row('Voice Hash', `<span class="highlight">${hash}</span>`),
    `<div class="data-row"><span class="data-key">First 10 Voices</span><span class="data-val">${first10 || 'None available'}</span></div>`,
  ].join(''));
  markDone('voices');
}

async function collectJSPrecision() {
  createSection('jsprec', 'üî¨', 'JS ENGINE PRECISION');
  setStatus('Probing JS engine precision...');
  const vals = {
    'Math.tan(-1e300)': Math.tan(-1e300),
    'Math.sinh(1)': Math.sinh(1),
    'Math.acos(0.123456789)': Math.acos(0.123456789),
    'Math.log(35)': Math.log(35),
    '0.1 + 0.2': (0.1 + 0.2),
    'Math.PI': Math.PI,
  };
  let stackFmt = 'N/A';
  try {
    const stack = new Error().stack || '';
    if (stack.includes('at ')) stackFmt = 'Chrome/V8 (at-style)';
    else if (stack.includes('@')) stackFmt = 'Firefox/SpiderMonkey (@-style)';
    else stackFmt = 'Safari/JavaScriptCore';
  } catch(e) {}
  let fnStr = 'N/A';
  try {
    const raw = (function(){}).toString();
    fnStr = raw === 'function (){}' ? 'Normalized' : raw.length <= 12 ? 'Space-normalized' : `Verbatim (${raw.length} chars)`;
  } catch(e) {}
  const hashInput = Object.values(vals).join('|') + stackFmt + fnStr;
  const hash = await simpleHash(hashInput);
  collected.jsprec = { hash };
  setBody('jsprec', [
    ...Object.entries(vals).map(([k, v]) => row(k, v.toString(), 'highlight')),
    row('Stack Trace Format', stackFmt),
    row('Function.toString()', fnStr),
    row('Engine Hash', `<span class="highlight">${hash}</span>`),
  ].join(''));
  markDone('jsprec');
}

async function collectCSSRender() {
  createSection('cssrender', 'üñåÔ∏è', 'CSS & RENDERING SIGNALS');
  setStatus('Probing CSS rendering signals...');
  let scrollbarW = 0;
  try {
    const div = document.createElement('div');
    div.style.cssText = 'overflow:scroll;width:100px;height:100px;position:absolute;left:-9999px;visibility:hidden';
    document.body.appendChild(div);
    scrollbarW = div.offsetWidth - div.clientWidth;
    document.body.removeChild(div);
  } catch(e) {}
  let sysFont = 'N/A';
  try { sysFont = getComputedStyle(document.body).fontFamily; } catch(e) {}
  const cssChecks = [
    ['color-scheme', 'color-scheme: light'],
    ['container-type', 'container-type: inline-size'],
    ['oklch()', 'color: oklch(70% 0.2 200)'],
    ['text-wrap: balance', 'text-wrap: balance'],
    ['accent-color', 'accent-color: red'],
    ['subgrid', 'grid-template-columns: subgrid'],
    ['@layer', 'layer()'],
    ['has()', 'selector(:has(a))'],
  ];
  const cssRows = cssChecks.map(([feat, q]) => {
    let sup = false;
    try { sup = CSS.supports(q); } catch(e) {}
    return row(`CSS ${feat}`, sup ? '<span class="highlight">‚úì Supported</span>' : '<span class="dim">‚úó No</span>');
  });
  let emojiW = 0, emojiH = 0;
  try {
    const ec = document.createElement('canvas');
    ec.width = 100; ec.height = 100;
    const ectx = ec.getContext('2d');
    ectx.font = '48px serif';
    ectx.fillText('üòÄ', 10, 70);
    const id = ectx.getImageData(0, 0, 100, 100).data;
    let minX = 100, maxX = 0, minY = 100, maxY = 0, found = false;
    for (let y = 0; y < 100; y++) for (let x = 0; x < 100; x++) {
      if (id[(y * 100 + x) * 4 + 3] > 0) {
        if (x < minX) minX = x; if (x > maxX) maxX = x;
        if (y < minY) minY = y; if (y > maxY) maxY = y;
        found = true;
      }
    }
    if (found && maxX > minX) { emojiW = maxX - minX; emojiH = maxY - minY; }
  } catch(e) {}
  collected.cssrender = { scrollbarW, sysFont };
  setBody('cssrender', [
    row('Scrollbar Width', `<span class="${scrollbarW > 0 ? 'warn' : 'highlight'}">${scrollbarW}px (reveals OS/theme)</span>`),
    row('System Font', sysFont.substring(0, 80)),
    ...cssRows,
    row('Emoji Render Size', emojiW > 0 ? `${emojiW} √ó ${emojiH}px` : 'N/A'),
  ].join(''));
  markDone('cssrender');
}

async function collectWebGLDeep() {
  createSection('webgldp', 'üîå', 'WEBGL DEEP FINGERPRINT');
  setStatus('Deep WebGL analysis...');
  const rows = [];
  let extCount = 0, extHash = 'N/A';
  try {
    const canvas = document.createElement('canvas');
    const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
    if (!gl) throw new Error('WebGL unavailable');
    const exts = gl.getSupportedExtensions() || [];
    extCount = exts.length;
    extHash = await simpleHash(exts.join(','));
    rows.push(row('Extensions Count', `<span class="highlight">${extCount}</span>`));
    rows.push(row('Extensions Hash', `<span class="highlight">${extHash}</span>`));
    for (const [shaderType, typeName] of [[gl.VERTEX_SHADER, 'VERTEX'], [gl.FRAGMENT_SHADER, 'FRAGMENT']]) {
      try {
        const p = gl.getShaderPrecisionFormat(shaderType, gl.HIGH_FLOAT);
        if (p) rows.push(row(`${typeName} HIGH_FLOAT`, `range:[${p.rangeMin},${p.rangeMax}] prec:${p.precision}`));
      } catch(e) {}
    }
    const params = [
      ['MAX_VERTEX_UNIFORM_VECTORS', gl.MAX_VERTEX_UNIFORM_VECTORS],
      ['MAX_FRAGMENT_UNIFORM_VECTORS', gl.MAX_FRAGMENT_UNIFORM_VECTORS],
      ['MAX_VARYING_VECTORS', gl.MAX_VARYING_VECTORS],
      ['MAX_VERTEX_ATTRIBS', gl.MAX_VERTEX_ATTRIBS],
      ['MAX_TEXTURE_IMAGE_UNITS', gl.MAX_TEXTURE_IMAGE_UNITS],
      ['MAX_RENDERBUFFER_SIZE', gl.MAX_RENDERBUFFER_SIZE],
    ];
    for (const [name, param] of params) {
      try { const v = gl.getParameter(param); rows.push(row(name, v !== null ? v.toString() : 'N/A')); } catch(e) {}
    }
    try { const r = gl.getParameter(gl.ALIASED_LINE_WIDTH_RANGE); rows.push(row('ALIASED_LINE_WIDTH_RANGE', r ? `[${r[0]}, ${r[1]}]` : 'N/A')); } catch(e) {}
    try { const r = gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE); rows.push(row('ALIASED_POINT_SIZE_RANGE', r ? `[${r[0]}, ${r[1]}]` : 'N/A')); } catch(e) {}
  } catch(e) {
    rows.push(row('WebGL', 'Not available: ' + e.message));
  }
  let gl2 = false;
  try { gl2 = !!document.createElement('canvas').getContext('webgl2'); } catch(e) {}
  rows.push(row('WebGL2', gl2 ? '<span class="highlight">‚úì Available</span>' : '<span class="dim">‚úó No</span>'));
  let gpuInfo = 'Not available';
  try {
    if (navigator.gpu) {
      const adapter = await navigator.gpu.requestAdapter();
      if (adapter) {
        const info = await adapter.requestAdapterInfo().catch(() => ({}));
        gpuInfo = `${info.vendor || 'Unknown vendor'} / ${info.architecture || 'N/A'}`;
      } else { gpuInfo = 'No adapter found'; }
    }
  } catch(e) { gpuInfo = 'API present, failed: ' + e.message.substring(0, 30); }
  rows.push(row('WebGPU Adapter', `<span class="${gpuInfo !== 'Not available' ? 'highlight' : 'dim'}">${gpuInfo}</span>`));
  collected.webgldp = { extCount, extHash };
  setBody('webgldp', rows.join(''));
  markDone('webgldp');
}

async function collectPrivMode() {
  createSection('privmode', 'üïµÔ∏è', 'PRIVATE MODE & HEADLESS');
  setStatus('Analyzing private/headless signals...');
  const sig = (key, val, label, cls) =>
    row(key, `<span class="${cls}" style="margin-right:6px">[${label}]</span>${val}`);
  const rows = [];
  const flags = [];
  const wd = !!navigator.webdriver;
  flags.push(wd);
  rows.push(sig('navigator.webdriver', wd ? 'Bot/Selenium detected' : 'Not set', wd ? 'HEADLESS' : 'NORMAL', wd ? 'danger' : 'highlight'));
  let quotaMB = null;
  try { const e = await navigator.storage?.estimate(); if (e) quotaMB = Math.round(e.quota / 1048576); } catch(e) {}
  const smallQuota = quotaMB !== null && quotaMB < 120;
  flags.push(smallQuota);
  rows.push(sig('Storage Quota', quotaMB !== null ? `${quotaMB} MB` : 'N/A', smallQuota ? 'SUSPICIOUS' : 'NORMAL', smallQuota ? 'warn' : 'highlight'));
  const noPlugins = (navigator.plugins?.length ?? 0) === 0;
  flags.push(noPlugins);
  rows.push(sig('Plugins Count', (navigator.plugins?.length ?? 0).toString(), noPlugins ? 'SUSPICIOUS' : 'NORMAL', noPlugins ? 'warn' : 'highlight'));
  const hasChrome = !!window.chrome;
  flags.push(!hasChrome);
  rows.push(sig('window.chrome', hasChrome ? 'Present' : 'Absent', hasChrome ? 'NORMAL' : 'SUSPICIOUS', hasChrome ? 'highlight' : 'warn'));
  const times = Array.from({ length: 10 }, () => Date.now());
  const allSame = times.every(t => t === times[0]);
  flags.push(allSame);
  rows.push(sig('Timing Jitter', allSame ? 'All identical ‚Äî VM suspected' : 'Varied (normal)', allSame ? 'SUSPICIOUS' : 'NORMAL', allSame ? 'warn' : 'highlight'));
  const outerZero = window.outerWidth === 0;
  flags.push(outerZero);
  rows.push(sig('outerWidth', window.outerWidth.toString(), outerZero ? 'HEADLESS' : 'NORMAL', outerZero ? 'danger' : 'highlight'));
  const hasPWA = 'onbeforeinstallprompt' in window;
  rows.push(sig('PWA Support', hasPWA ? 'Available' : 'Not available', hasPWA ? 'NORMAL' : 'SUSPICIOUS', hasPWA ? 'highlight' : 'warn'));
  const suspicious = flags.filter(Boolean).length;
  const verdict = suspicious >= 3 ? 'LIKELY HEADLESS / BOT' : suspicious >= 1 ? 'SUSPICIOUS SIGNALS' : 'APPEARS NORMAL';
  const vCls = suspicious >= 3 ? 'danger' : suspicious >= 1 ? 'warn' : 'highlight';
  collected.privmode = { suspiciousCount: suspicious, verdict };
  setBody('privmode', [
    row('VERDICT', `<span class="${vCls}" style="font-weight:bold">${verdict}</span>`),
    ...rows,
  ].join(''));
  markDone('privmode');
}

async function collectNATInfo() {
  createSection('natinfo', 'üõ∞Ô∏è', 'NETWORK NAT & WEBRTC EXTENDED');
  setStatus('Analyzing NAT topology via ICE candidates...');
  const candidateTypes = { host: [], srflx: [], relay: [] };
  let publicIP = null;
  try {
    await new Promise(resolve => {
      const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      pc.createDataChannel('');
      pc.onicecandidate = e => {
        if (!e || !e.candidate) { pc.close(); resolve(); return; }
        const c = e.candidate.candidate;
        const typeM = c.match(/typ (\w+)/);
        const ipM = c.match(/(\d+\.\d+\.\d+\.\d+)/);
        if (typeM) {
          const t = typeM[1];
          const ip = ipM ? ipM[1] : 'unknown';
          if (candidateTypes[t]) candidateTypes[t].push(ip);
          else candidateTypes[t] = [ip];
          if (t === 'srflx' && ip && !ip.startsWith('10.') && !ip.startsWith('192.168.') && !ip.match(/^172\.(1[6-9]|2\d|3[01])\./))
            publicIP = ip;
        }
      };
      pc.createOffer().then(o => pc.setLocalDescription(o)).catch(() => {});
      setTimeout(resolve, 3000);
    });
  } catch(e) {}
  const hasHost = candidateTypes.host.length > 0;
  const hasSrflx = candidateTypes.srflx.length > 0;
  const hasRelay = candidateTypes.relay.length > 0;
  let natType, natCls;
  if (hasRelay) { natType = 'Symmetric / Corporate (TURN relay used)'; natCls = 'danger'; }
  else if (hasSrflx && hasHost) { natType = 'Moderate NAT (cone)'; natCls = 'warn'; }
  else if (hasSrflx && !hasHost) { natType = 'Strict NAT (no host candidates)'; natCls = 'warn'; }
  else if (hasHost && !hasSrflx) { natType = 'Open / No STUN traversal'; natCls = 'highlight'; }
  else { natType = 'Unknown ‚Äî no ICE candidates'; natCls = ''; }
  collected.natinfo = { natType, publicIP, hasRelay, hasSrflx };
  setBody('natinfo', [
    row('NAT Type', `<span class="${natCls}">${natType}</span>`),
    row('Host Candidates', candidateTypes.host.length.toString()),
    row('Server-Reflexive (srflx)', candidateTypes.srflx.length + (hasSrflx ? ' ‚Äî STUN traversal OK' : '')),
    row('Relay Candidates', hasRelay ? `<span class="danger">${candidateTypes.relay.length} ‚Äî TURN/proxy in use</span>` : '0'),
    row('Public IP (srflx)', publicIP ? `<span class="danger">${publicIP}</span>` : 'Not exposed'),
    row('Host IPs (first 3)', candidateTypes.host.slice(0, 3).join(', ') || 'None'),
  ].join(''));
  markDone('natinfo');
}

async function collectWASM() {
  createSection('wasm', '‚öôÔ∏è', 'WASM CAPABILITIES');
  setStatus('Probing WebAssembly features...');
  const rows = [];
  const features = {};
  const wasmAvail = typeof WebAssembly !== 'undefined';
  features.basic = wasmAvail;
  rows.push(row('WebAssembly', wasmAvail ? '<span class="highlight">‚úì Available</span>' : '<span class="danger">‚úó Not available</span>'));
  if (wasmAvail) {
    // SIMD: minimal wasm with v128.const opcode
    try {
      const b = new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,
        10,15,1,13,0,253,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11]);
      features.simd = WebAssembly.validate(b);
    } catch(e) { features.simd = false; }
    rows.push(row('SIMD (v128)', features.simd ? '<span class="highlight">‚úì Supported</span>' : '<span class="dim">‚úó No</span>'));
    features.threads = typeof SharedArrayBuffer !== 'undefined';
    rows.push(row('Threads (SharedArrayBuffer)', features.threads ? '<span class="highlight">‚úì Available</span>' : '<span class="dim">‚úó No</span>'));
    features.exceptions = typeof WebAssembly.Tag !== 'undefined';
    rows.push(row('Exception Handling (Tag)', features.exceptions ? '<span class="highlight">‚úì WebAssembly.Tag</span>' : '<span class="dim">‚úó No</span>'));
    // Tail calls: return_call opcode (0x12)
    try {
      const b = new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,10,6,1,4,0,18,0,11]);
      features.tailCalls = WebAssembly.validate(b);
    } catch(e) { features.tailCalls = false; }
    rows.push(row('Tail Calls', features.tailCalls ? '<span class="highlight">‚úì Supported</span>' : '<span class="dim">‚úó No</span>'));
    // Memory64: memory with 64-bit index (flag byte = 4)
    try {
      const b = new Uint8Array([0,97,115,109,1,0,0,0,5,3,1,4,1]);
      features.memory64 = WebAssembly.validate(b);
    } catch(e) { features.memory64 = false; }
    rows.push(row('Memory64', features.memory64 ? '<span class="highlight">‚úì Supported</span>' : '<span class="dim">‚úó No</span>'));
    const supportedCount = Object.values(features).filter(Boolean).length;
    rows.push(row('Features Supported', `<span class="highlight">${supportedCount} / ${Object.keys(features).length}</span>`));
    collected.wasm = { available: true, features, supportedCount };
  } else {
    collected.wasm = { available: false, supportedCount: 0 };
  }
  setBody('wasm', rows.join(''));
  markDone('wasm');
}

async function collectBehavior() {
  createSection('behavior', 'üß†', 'BEHAVIORAL BOOTSTRAP');
  setStatus('Displaying behavioral signals...');
  const pts = _behaviorData.mousePoints;
  let avgSpeed = null;
  if (pts.length >= 2) {
    let totalDist = 0, totalTime = 0;
    for (let i = 1; i < pts.length; i++) {
      const dx = pts[i].x - pts[i-1].x, dy = pts[i].y - pts[i-1].y;
      totalDist += Math.sqrt(dx*dx + dy*dy);
      totalTime += Math.max(1, pts[i].t - pts[i-1].t);
    }
    avgSpeed = (totalDist / totalTime * 1000).toFixed(1);
  }
  const fs = _behaviorData.scrollEvents[0];
  const renderBody = () => {
    const pts2 = _behaviorData.mousePoints;
    let spd = null;
    if (pts2.length >= 2) {
      let d = 0, t = 0;
      for (let i = 1; i < pts2.length; i++) {
        const dx = pts2[i].x - pts2[i-1].x, dy = pts2[i].y - pts2[i-1].y;
        d += Math.sqrt(dx*dx + dy*dy); t += Math.max(1, pts2[i].t - pts2[i-1].t);
      }
      spd = (d / t * 1000).toFixed(1);
    }
    const fs2 = _behaviorData.scrollEvents[0];
    collected.behavior = { firstInteraction: _behaviorData.firstInteraction, modality: _behaviorData.modality, mousePoints: pts2.length, avgSpeed: spd };
    return [
      row('Note', '<span class="dim">Passive collection ‚Äî interact with page to generate data</span>'),
      row('Time-to-First-Interaction', _behaviorData.firstInteraction !== null ? `<span class="highlight">${_behaviorData.firstInteraction}ms</span>` : '<span class="loading">waiting...</span>'),
      row('Input Modality', _behaviorData.modality ? `<span class="highlight">${_behaviorData.modality.toUpperCase()}</span>` : '<span class="loading">waiting...</span>'),
      row('Mouse Points Captured', `${pts2.length} / 20`),
      row('Avg Mouse Speed', spd !== null ? `<span class="highlight">${spd} px/s</span>` : pts2.length < 2 ? 'Move mouse to collect' : 'N/A'),
      row('First Scroll', fs2 ? `at ${fs2.t}ms, Y=${fs2.y}px` : 'No scroll yet'),
    ].join('');
  };
  collected.behavior = { firstInteraction: _behaviorData.firstInteraction, modality: _behaviorData.modality, mousePoints: pts.length, avgSpeed };
  setBody('behavior', renderBody());
  markDone('behavior');
  // Live update after 5s
  setTimeout(() => {
    const el = document.getElementById('body-behavior');
    if (el) el.innerHTML = renderBody();
  }, 5000);
}

// ‚îÄ‚îÄ‚îÄ Benchmark helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function benchBar(label, value, unit, pct, color) {
  const c = color || (pct > 66 ? 'var(--accent3)' : pct > 33 ? 'var(--warn)' : 'var(--accent2)');
  const w = Math.min(100, Math.max(0, pct));
  return `<div class="data-row">
    <span class="data-key" style="font-size:10px">${label}</span>
    <span class="data-val">
      <span style="color:var(--text-bright)">${value} <span style="color:var(--dim)">${unit}</span></span>
      <div class="latency-bar"><div class="latency-fill" style="width:${w}%;background:${c}"></div></div>
    </span>
  </div>`;
}

async function runBenchmarks() {
  createSection('benchmarks', 'üìä', 'PERFORMANCE BENCHMARKS');
  setStatus('Running benchmarks...');
  setBody('benchmarks', row('Status', '<span class="loading">Running CPU benchmarks...</span>'));
  const results = {};
  const deadline = performance.now() + 5000;
  const ok = () => performance.now() < deadline;
  const tick = () => new Promise(r => setTimeout(r, 0));

  // CPU: Integer arithmetic
  try {
    if (ok()) {
      await tick();
      const n = 10_000_000; let s = 0;
      const t0 = performance.now();
      for (let i = 0; i < n; i++) s = (s + i) | 0;
      const ms = performance.now() - t0;
      results.intOps = { v: Math.round(n / ms), u: 'ops/ms', l: 'Integer Arith (10M adds)' };
    }
  } catch(e) {}

  // CPU: Float arithmetic
  try {
    if (ok()) {
      await tick();
      const n = 1_000_000; let s = 0;
      const t0 = performance.now();
      for (let i = 0; i < n; i++) s += Math.sqrt(i + 1);
      const ms = performance.now() - t0;
      results.floatOps = { v: Math.round(n / ms), u: 'ops/ms', l: 'Float Arith (1M sqrt)' };
    }
  } catch(e) {}

  // CPU: Crypto SHA-256 on 1MB
  try {
    if (ok()) {
      await tick();
      const buf = crypto.getRandomValues(new Uint8Array(1024 * 1024));
      const t0 = performance.now();
      await crypto.subtle.digest('SHA-256', buf);
      const ms = performance.now() - t0;
      results.cryptoMBps = { v: (1000 / ms).toFixed(1), u: 'MB/s', l: 'Crypto SHA-256 (1MB)' };
    }
  } catch(e) {}

  // CPU: JSON parse+stringify
  try {
    if (ok()) {
      await tick();
      const arr = Array.from({ length: 10000 }, (_, i) => ({ id: i, v: Math.random(), n: 'item' + i }));
      const n = 100; const t0 = performance.now();
      for (let i = 0; i < n; i++) JSON.parse(JSON.stringify(arr));
      const ms = performance.now() - t0;
      results.jsonOps = { v: (n / ms).toFixed(2), u: 'ops/ms', l: 'JSON parse+stringify (10K√ó100)' };
    }
  } catch(e) {}

  // CPU: String concatenation
  try {
    if (ok()) {
      await tick();
      const n = 1_000_000; let s = ''; const t0 = performance.now();
      for (let i = 0; i < n; i++) s = 'str' + i;
      const ms = performance.now() - t0;
      results.stringOps = { v: Math.round(n / ms), u: 'ops/ms', l: 'String Concat (1M)' };
    }
  } catch(e) {}

  // CPU: Sort 100K floats
  try {
    if (ok()) {
      await tick();
      const arr = Array.from({ length: 100000 }, () => Math.random());
      const t0 = performance.now();
      arr.sort((a, b) => a - b);
      const ms = Math.round(performance.now() - t0);
      results.sortMs = { v: ms, u: 'ms', l: 'Sort 100K floats' };
    }
  } catch(e) {}

  setBody('benchmarks', row('Status', '<span class="loading">Running memory benchmarks...</span>'));
  await tick();

  // Memory: ArrayBuffer max alloc
  try {
    if (ok()) {
      let maxMB = 0;
      for (let mb = 64; mb <= 512; mb += 64) {
        try { new ArrayBuffer(mb * 1024 * 1024); maxMB = mb; } catch(e) { break; }
      }
      results.maxAlloc = { v: maxMB, u: 'MB', l: 'Max ArrayBuffer Alloc' };
    }
  } catch(e) {}

  // Memory: Sequential read 10MB
  try {
    if (ok()) {
      await tick();
      const sz = 10 * 1024 * 1024;
      const buf = new Uint8Array(sz); let sum = 0;
      const t0 = performance.now();
      for (let i = 0; i < sz; i++) sum += buf[i];
      const ms = performance.now() - t0;
      results.seqRead = { v: ((sz / 1e9) / (ms / 1000)).toFixed(2), u: 'GB/s', l: 'Sequential Read (10MB)' };
    }
  } catch(e) {}

  // Memory: Random read 1M ops on 10MB
  try {
    if (ok()) {
      await tick();
      const sz = 10 * 1024 * 1024;
      const buf = new Uint8Array(sz); const n = 1_000_000; let sum = 0;
      const t0 = performance.now();
      for (let i = 0; i < n; i++) sum += buf[(Math.random() * sz) | 0];
      const ms = performance.now() - t0;
      results.randRead = { v: (n / ms / 1000).toFixed(2), u: 'Mops/s', l: 'Random Read (1M ops)' };
    }
  } catch(e) {}

  // IO: LocalStorage write 1MB in 1KB chunks
  try {
    if (ok()) {
      await tick();
      const chunk = 'x'.repeat(1024); const n = 1000;
      const t0 = performance.now();
      for (let i = 0; i < n; i++) localStorage.setItem('_b' + i, chunk);
      const ms = performance.now() - t0;
      for (let i = 0; i < n; i++) localStorage.removeItem('_b' + i);
      results.lsWrite = { v: Math.round(n / ms * 1000), u: 'KB/s', l: 'LocalStorage Write (1MB)' };
    }
  } catch(e) {}

  // IO: IndexedDB write 1000√ó1KB
  try {
    if (ok()) {
      await tick();
      const idbVal = await new Promise(resolve => {
        try {
          const req = indexedDB.open('_fpb', 1);
          req.onupgradeneeded = e => e.target.result.createObjectStore('b');
          req.onsuccess = e => {
            const db = e.target.result;
            const chunk = new Uint8Array(1024);
            const t0 = performance.now();
            const tx = db.transaction('b', 'readwrite');
            const store = tx.objectStore('b');
            for (let i = 0; i < 1000; i++) store.put(chunk, i);
            tx.oncomplete = () => { const ms = performance.now() - t0; db.close(); indexedDB.deleteDatabase('_fpb'); resolve(Math.round(1000 / ms * 1000)); };
            tx.onerror = () => resolve(null);
          };
          req.onerror = () => resolve(null);
          setTimeout(() => resolve(null), 3000);
        } catch(e) { resolve(null); }
      });
      if (idbVal !== null) results.idbOps = { v: idbVal, u: 'ops/s', l: 'IndexedDB Write (1K records)' };
    }
  } catch(e) {}

  setBody('benchmarks', row('Status', '<span class="loading">Running GPU benchmarks...</span>'));
  await tick();

  // GPU setup
  let gl = null;
  try {
    const gc = document.createElement('canvas');
    gc.width = 512; gc.height = 512;
    gl = gc.getContext('webgl') || gc.getContext('experimental-webgl');
  } catch(e) {}

  // GPU: Triangle throughput
  try {
    if (gl && ok()) {
      await tick();
      const vs = gl.createShader(gl.VERTEX_SHADER);
      gl.shaderSource(vs, 'attribute vec2 p;void main(){gl_Position=vec4(p,0,1);}');
      gl.compileShader(vs);
      const fs = gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(fs, 'void main(){gl_FragColor=vec4(1,0,0,1);}');
      gl.compileShader(fs);
      const prog = gl.createProgram();
      gl.attachShader(prog, vs); gl.attachShader(prog, fs); gl.linkProgram(prog);
      gl.useProgram(prog);
      const tc = 10000;
      const verts = new Float32Array(tc * 6);
      for (let i = 0; i < tc; i++) {
        const x = (i / tc) * 2 - 1;
        verts[i*6]=x; verts[i*6+1]=0; verts[i*6+2]=x+0.01; verts[i*6+3]=0.01; verts[i*6+4]=x+0.02; verts[i*6+5]=-0.01;
      }
      const buf = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, buf);
      gl.bufferData(gl.ARRAY_BUFFER, verts, gl.STATIC_DRAW);
      const loc = gl.getAttribLocation(prog, 'p');
      gl.enableVertexAttribArray(loc);
      gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);
      const frames = 100; const t0 = performance.now();
      for (let f = 0; f < frames; f++) { gl.clear(gl.COLOR_BUFFER_BIT); gl.drawArrays(gl.TRIANGLES, 0, tc * 3); }
      const px = new Uint8Array(4); gl.readPixels(0, 0, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, px);
      gl.getError();
      const ms = performance.now() - t0;
      results.gpuTris = { v: (tc * frames / ms / 1000).toFixed(2), u: 'Mtri/s', l: 'Triangle Throughput (10K√ó100f)' };
    }
  } catch(e) { if (gl) gl.getError(); }

  // GPU: Texture fill rate (clear 1000√ó)
  try {
    if (gl && ok()) {
      await tick();
      gl.viewport(0, 0, 512, 512);
      const frames = 1000; const t0 = performance.now();
      for (let i = 0; i < frames; i++) gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
      const px = new Uint8Array(4); gl.readPixels(0, 0, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, px);
      gl.getError();
      const ms = performance.now() - t0;
      results.gpuFill = { v: (512 * 512 * frames / ms / 1e6).toFixed(1), u: 'Mpix/s', l: 'Texture Fill Rate (512¬≤√ó1000f)' };
    }
  } catch(e) { if (gl) gl.getError(); }

  // GPU: GPGPU heavy fragment shader
  try {
    if (gl && ok()) {
      await tick();
      const vs2 = gl.createShader(gl.VERTEX_SHADER);
      gl.shaderSource(vs2, 'attribute vec2 p;varying vec2 uv;void main(){uv=p*0.5+0.5;gl_Position=vec4(p,0,1);}');
      gl.compileShader(vs2);
      const fs2 = gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(fs2, 'precision highp float;varying vec2 uv;void main(){float v=0.0;for(int i=0;i<1000;i++)v+=sin(float(i)*uv.x)*cos(float(i)*uv.y);gl_FragColor=vec4(v,0,0,1);}');
      gl.compileShader(fs2);
      if (gl.getShaderParameter(fs2, gl.COMPILE_STATUS)) {
        const prog2 = gl.createProgram();
        gl.attachShader(prog2, vs2); gl.attachShader(prog2, fs2); gl.linkProgram(prog2);
        gl.useProgram(prog2);
        const verts2 = new Float32Array([-1,-1, 1,-1, -1,1, 1,1]);
        const buf2 = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buf2);
        gl.bufferData(gl.ARRAY_BUFFER, verts2, gl.STATIC_DRAW);
        const loc2 = gl.getAttribLocation(prog2, 'p');
        gl.enableVertexAttribArray(loc2);
        gl.vertexAttribPointer(loc2, 2, gl.FLOAT, false, 0, 0);
        gl.viewport(0, 0, 512, 512);
        const t0 = performance.now();
        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
        const px2 = new Uint8Array(4); gl.readPixels(0, 0, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, px2);
        gl.getError();
        const ms = performance.now() - t0;
        // rough: 512*512 pixels √ó 1000 iterations √ó 4 flops (sin+cos+mul+add) per pixel
        const gflops = ((512 * 512 * 1000 * 4) / ms / 1e9 * 1000).toFixed(3);
        results.gpuGFLOPS = { v: gflops, u: 'GFLOPS (est.)', l: 'GPGPU Compute (512¬≤ shader)' };
        results.gpuFrameMs = { v: ms.toFixed(1), u: 'ms/frame', l: 'GPGPU Frame Time' };
      }
    }
  } catch(e) { if (gl) gl.getError(); }

  // Render all results
  collected.benchmarks = { intOps: results.intOps?.v, gpuFill: results.gpuFill?.v };
  const benchRows = [];
  const hdr = t => `<div style="color:var(--accent);font-family:'Orbitron',monospace;font-size:9px;letter-spacing:2px;padding:6px 0 2px;border-top:1px solid var(--border)">‚îÄ‚îÄ ${t} ‚îÄ‚îÄ</div>`;
  benchRows.push(hdr('CPU'));
  if (results.intOps)    benchRows.push(benchBar(results.intOps.l,    Number(results.intOps.v).toLocaleString(),  results.intOps.u,    Math.min(100, results.intOps.v / 100000 * 100)));
  if (results.floatOps)  benchRows.push(benchBar(results.floatOps.l,  Number(results.floatOps.v).toLocaleString(), results.floatOps.u, Math.min(100, results.floatOps.v / 50000 * 100)));
  if (results.cryptoMBps)benchRows.push(benchBar(results.cryptoMBps.l, results.cryptoMBps.v, results.cryptoMBps.u, Math.min(100, results.cryptoMBps.v / 2000 * 100)));
  if (results.jsonOps)   benchRows.push(benchBar(results.jsonOps.l,   results.jsonOps.v,   results.jsonOps.u,   Math.min(100, results.jsonOps.v / 5 * 100)));
  if (results.stringOps) benchRows.push(benchBar(results.stringOps.l, Number(results.stringOps.v).toLocaleString(), results.stringOps.u, Math.min(100, results.stringOps.v / 200000 * 100)));
  if (results.sortMs)    benchRows.push(benchBar(results.sortMs.l,    results.sortMs.v,    results.sortMs.u,    Math.min(100, Math.max(0, (200 - results.sortMs.v) / 200 * 100))));
  benchRows.push(hdr('MEMORY / IO'));
  if (results.maxAlloc)  benchRows.push(benchBar(results.maxAlloc.l,  results.maxAlloc.v,  results.maxAlloc.u,  Math.min(100, results.maxAlloc.v / 512 * 100)));
  if (results.seqRead)   benchRows.push(benchBar(results.seqRead.l,   results.seqRead.v,   results.seqRead.u,   Math.min(100, results.seqRead.v / 10 * 100)));
  if (results.randRead)  benchRows.push(benchBar(results.randRead.l,  results.randRead.v,  results.randRead.u,  Math.min(100, results.randRead.v / 100 * 100)));
  if (results.lsWrite)   benchRows.push(benchBar(results.lsWrite.l,   Number(results.lsWrite.v).toLocaleString(), results.lsWrite.u, Math.min(100, results.lsWrite.v / 5000 * 100)));
  if (results.idbOps)    benchRows.push(benchBar(results.idbOps.l,    Number(results.idbOps.v).toLocaleString(),  results.idbOps.u,  Math.min(100, results.idbOps.v / 10000 * 100)));
  benchRows.push(hdr('GPU'));
  if (results.gpuTris)   benchRows.push(benchBar(results.gpuTris.l,   results.gpuTris.v,   results.gpuTris.u,   Math.min(100, results.gpuTris.v / 100 * 100)));
  if (results.gpuFill)   benchRows.push(benchBar(results.gpuFill.l,   results.gpuFill.v,   results.gpuFill.u,   Math.min(100, results.gpuFill.v / 10000 * 100)));
  if (results.gpuGFLOPS) benchRows.push(benchBar(results.gpuGFLOPS.l, results.gpuGFLOPS.v, results.gpuGFLOPS.u, Math.min(100, results.gpuGFLOPS.v / 5 * 100)));
  if (results.gpuFrameMs)benchRows.push(benchBar(results.gpuFrameMs.l, results.gpuFrameMs.v, results.gpuFrameMs.u, 0, 'var(--dim)'));
  if (benchRows.length <= 3) benchRows.push(row('Status', '<span class="warn">No benchmarks completed (5s timeout or WebGL unavailable)</span>'));
  setBody('benchmarks', benchRows.join(''));
  markDone('benchmarks');
}

// ‚îÄ‚îÄ‚îÄ Extension Fingerprint ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function collectExtensions() {
  createSection('extfp', 'üß©', 'EXTENSION FINGERPRINT');
  setStatus('Probing installed extensions...');

  // Database: extensions detectable via web-accessible resources
  // Source: github.com/znck/extension-fingerprints (MIT)
  const EXT = [
    // ‚îÄ‚îÄ‚îÄ Ad Blockers
    { n: 'AdBlock', id: 'gighmmpiobklfepjocnamgkkbiglidom', f: 'adblock-uiscripts-adblock-wizard.css', c: 'Ad Blockers' },
    { n: 'Ghostery', id: 'mlomiejdfkolichcflejclcbmpeaniij', f: 'app/templates/trackers-preview.html', c: 'Ad Blockers' },
    { n: 'AdBlocker Ultimate', id: 'ohahllgiabjaoigichmmfljhkcfikeof', f: 'lib/content-script/assistant/css/font-awesome.min.css', c: 'Ad Blockers' },
    { n: 'Total Adblock', id: 'gekdekpbfehejjiecgonmgmepbdnaggp', f: 'assets/img/_brand/icon/120px.png', c: 'Ad Blockers' },
    { n: 'Adblocker for Youtube‚Ñ¢', id: 'maekfnoeejhpjfkfmdlckioggdcdofpg', f: 'css/content.css', c: 'Ad Blockers' },
    { n: 'Adblock Plus', id: 'cfhdojbkjhnklbpkdaibdccddilifddb', f: 'skin/abp-icon-32.png', c: 'Ad Blockers' },
    // ‚îÄ‚îÄ‚îÄ Privacy / VPN
    { n: 'DuckDuckGo Privacy', id: 'bkdgflcldnnnapblkhphbgpggdiikppg', f: 'img/logo-small.svg', c: 'Privacy/VPN' },
    { n: 'ExpressVPN', id: 'fgddmllnllkalaagkghckoinaemmogpe', f: 'html/networkLock.html', c: 'Privacy/VPN' },
    { n: 'Surfshark VPN', id: 'ailoabdmgclmfmhdagmlohpjlbpffblp', f: 'Roboto-Bold.woff', c: 'Privacy/VPN' },
    { n: 'Hotspot Shield VPN', id: 'nlbejmccbhkncgokjcmghpfloaajcffj', f: 'static/assets/connection_button/connected.png', c: 'Privacy/VPN' },
    { n: 'VPN Unlimited', id: 'mpcaainmfjjigeicjnlkdfajbioopjko', f: 'icons/app_icon_connected_128.png', c: 'Privacy/VPN' },
    { n: 'ClearURLs', id: 'lckanjgmijmafbedlnfblio3fnkbkbmh', f: 'img/clearurls.svg', c: 'Privacy/VPN' },
    // ‚îÄ‚îÄ‚îÄ Password Managers
    { n: 'LastPass', id: 'hdokiejnpimakedhajhdlcegeplioahd', f: 'overlay.html', c: 'Password Mgr' },
    { n: 'Dashlane', id: 'fdjamakpfbbddfjaooikfcpapjohcfmg', f: 'content/webui/index.html', c: 'Password Mgr' },
    { n: 'Bitwarden', id: 'nngceckbapebfimnlniiiahkandclblb', f: 'notification/bar.html', c: 'Password Mgr' },
    { n: '1Password', id: 'aeblfdkhhhdcdjpifhhbdiojplfjncoa', f: 'inline/menu/menu.html', c: 'Password Mgr' },
    { n: 'RoboForm', id: 'pnlccmojcmeohlpggmfnbbiapkmbliob', f: 'password-generator.html', c: 'Password Mgr' },
    { n: 'NordPass', id: 'fooolghllnmhmmndgjiamiiodkpenpbb', f: 'autofill.html', c: 'Password Mgr' },
    { n: 'Keeper Password Manager', id: 'bfogiafebfohielmmehodmfbbebbbpei', f: 'data/popup/keeperfill.html', c: 'Password Mgr' },
    // ‚îÄ‚îÄ‚îÄ Shopping
    { n: 'Honey', id: 'bmnlcjabgnpnenekpadlanbbkooimhnj', f: 'checkoutPaypal/paypal/context.js', c: 'Shopping' },
    { n: 'Rakuten', id: 'chhjbpecpncaggjpdakmflnfcopglcmi', f: 'content/style.css', c: 'Shopping' },
    { n: 'Capital One Shopping', id: 'nenlahapcbofgnanklpelkaejcehkggg', f: 'GENERATED/analytics.js', c: 'Shopping' },
    { n: 'Ibotta', id: 'mfaedmjlefifhnhpgipjjiiekchaimpk', f: 'static/media/cash_register.mp3', c: 'Shopping' },
    // ‚îÄ‚îÄ‚îÄ Google Suite
    { n: 'Google Translate', id: 'aapbdbdomjkkjkaonfhkkikfgjllcleb', f: 'popup_css_compiled.css', c: 'Google Suite' },
    { n: 'Google Docs Offline', id: 'ghbmnnjooekpmoecnnnilnnbdlolhkhi', f: 'page_embed_script.js', c: 'Google Suite' },
    { n: 'Google Keep', id: 'lpcaedmchfhocbbapmcbpinfpgnhiddi', f: 'index.html', c: 'Google Suite' },
    { n: 'Save to Google Drive', id: 'gmbmikajjgmnabiglmofipeabaddhgne', f: 'images/driveicon32.png', c: 'Google Suite' },
    { n: 'Google Input Tools', id: 'mclkkofklkfljcocdinagocijmpgbhab', f: '_locales/am/messages.json', c: 'Google Suite' },
    { n: 'Checker Plus for Google Calendar', id: 'hkhggnncdpfibdhinjiegagmopldibha', f: 'options.html', c: 'Google Suite' },
    // ‚îÄ‚îÄ‚îÄ Productivity
    { n: 'Grammarly', id: 'kbfnbcaeplbcioakkpcpgfkobkghlhen', f: 'src/fonts/0cde50f90fe61871de0af0d24e4d6f6b/extension-inter-light.woff', c: 'Productivity' },
    { n: 'Loom', id: 'liecbddmkiiihnedobmlmillhodjkdmb', f: 'css/content.css', c: 'Productivity' },
    { n: 'Screencastify', id: 'mmeijimgabbpbgpdklnllpncmdofkcpn', f: 'cam-frame.html', c: 'Productivity' },
    { n: 'Evernote Web Clipper', id: 'pioclpoplcdbaefihamjohnefbikjilc', f: 'consent.html', c: 'Productivity' },
    { n: 'Vidyard', id: 'jiihcciniecimeajcniapbngjjbonjan', f: 'authenticationInner.html', c: 'Productivity' },
    { n: 'Toggl Track', id: 'oejgccbfbmkkpaidnkphaiaecficdnfn', f: 'html/login.html', c: 'Productivity' },
    { n: 'Clockify', id: 'pmjeegjhjdlccodhacdgbgfagbpmccpe', f: 'assets/images/$-selected.png', c: 'Productivity' },
    { n: 'Todoist for Gmail', id: 'clgenfnodoocmhjlnpknojdbjjnmecff', f: 'frame.html', c: 'Productivity' },
    { n: 'Save to Notion', id: 'ldmmifpegigmeammaeckplhnjbbpccmm', f: 'popup/index.html', c: 'Productivity' },
    { n: 'Trello (Scrum)', id: 'jdbcdblgjdpmfninkoogcfpnkjmndgje', f: 'images/storypoints-icon.png', c: 'Productivity' },
    { n: 'Trello (Plus)', id: 'gjjpophepkbhejnglcmkdnncmaanojkf', f: 'manifest.json', c: 'Productivity' },
    { n: 'Trello (Planyway)', id: 'kkgaechmpjgbojahkofamdjkaljgbdkc', f: 'html/panel.html', c: 'Productivity' },
    { n: 'Pocket', id: 'milblmloammhichcaklnlkbpjgkjakfd', f: 'img/logo.png', c: 'Productivity' },
    // ‚îÄ‚îÄ‚îÄ Dark Mode
    { n: 'Dark Reader', id: 'eimadpbcbfnmbkopoojfekhnkhdbieeh', f: 'config/browser-css/browser.css', c: 'Dark Mode' },
    { n: 'Dark Mode', id: 'dmghijelimhndkbmpgbldicpogfkceaj', f: 'data/content_script/page_context/inject.js', c: 'Dark Mode' },
    { n: 'Night Eye', id: 'alncdjedloppbablonallfbkeiknmkdi', f: 'css/custom-styles.css', c: 'Dark Mode' },
    // ‚îÄ‚îÄ‚îÄ Video / Streaming
    { n: 'Teleparty (Netflix Party)', id: 'oocalimimngaihdkbihfgmpkcpnmlaoa', f: 'lib/tp_emoji/emoji-picker.json', c: 'Video/Stream' },
    { n: 'SponsorBlock', id: 'mnjggcdmjocbbbhaepdhchncahnbgone', f: 'icons/LogoSponsorBlocker256px.png', c: 'Video/Stream' },
    { n: 'vidIQ', id: 'pachckjkecffpdphbpmfolblodfkgbhl', f: 'options.html', c: 'Video/Stream' },
    { n: 'Video Speed Controller', id: 'nffaoalbilbmmfgbnbgppjihopabppdk', f: 'inject.css', c: 'Video/Stream' },
    // ‚îÄ‚îÄ‚îÄ Developer Tools
    { n: 'React Developer Tools', id: 'fmkadmapgofadopljbjfkapdkoienihi', f: 'main.html', c: 'Dev Tools' },
    { n: 'Redux DevTools', id: 'lmhkpmbekcpmknklioeibfkpmmfibljd', f: 'page.bundle.js', c: 'Dev Tools' },
    { n: 'Vue.js devtools', id: 'nhdogjmejiglipccpnnnanhbledajbpd', f: 'devtools.html', c: 'Dev Tools' },
    { n: 'Angular DevTools', id: 'ienfalfjdbdpebioblfackkekamfmbnh', f: 'devtools.html', c: 'Dev Tools' },
    { n: 'Wappalyzer', id: 'gppongmhjkpfnbhagpmjfkannfbllamg', f: 'js/js.js', c: 'Dev Tools' },
    { n: 'Web Developer', id: 'bfbameneiokkgbdmiekhjnmfkcnldhhm', f: '_locales/en_US/messages.json', c: 'Dev Tools' },
    { n: 'Octotree (GitHub)', id: 'bkhaagjahfmjljalopjnoealnfndnagc', f: 'fonts/anonymous-pro.woff2', c: 'Dev Tools' },
    { n: 'Refined GitHub', id: 'hlepfoohegkhhmjieoechaddaejaokhf', f: 'resolve-conflicts.js', c: 'Dev Tools' },
    { n: 'Tampermonkey', id: 'dhdgffkkebhmkfjojejmpbldmpobfkfo', f: 'tampermonkey.html', c: 'Dev Tools' },
    { n: 'Violentmonkey', id: 'jinjaccalgkegedbjkdiaebcehnmkjef', f: 'background.html', c: 'Dev Tools' },
    { n: 'JSON Formatter', id: 'bcjindcccaagfpapjibcdoeiaomchdeh', f: 'manifest.json', c: 'Dev Tools' },
    // ‚îÄ‚îÄ‚îÄ Crypto / Web3
    { n: 'Coinbase Wallet', id: 'hnfanknocfeofbddgcijnmhnfnkdnaad', f: 'requestProvider.js', c: 'Crypto/Web3' },
    { n: 'XDEFI Wallet', id: 'hmeobnfnfcmdkdcmlblgagmfpfboieaf', f: 'js/inPage.bundle.js', c: 'Crypto/Web3' },
    { n: 'MEW CX (MyEtherWallet)', id: 'nlbmnnijcnlegkjjpcfjclmcfggfefdm', f: 'js/cxWeb3.js', c: 'Crypto/Web3' },
    // ‚îÄ‚îÄ‚îÄ Security / AV
    { n: 'Avast Online Security', id: 'gomekmidlodglbbmalcneegieacbdmki', f: 'common/mocks/empty.js', c: 'Security/AV' },
    { n: 'Malwarebytes', id: 'ihcjicgdanjaechkgeegckofjjedodee', f: 'app/assets/close-icon.svg', c: 'Security/AV' },
    { n: 'McAfee Web Control', id: 'jjkchpdmjjdmalgembblgafllbpcjlei', f: 'Resources/mcafee.gif', c: 'Security/AV' },
    { n: 'Norton Password Manager', id: 'admmjipmmciaobhojoghlmleefbicajg', f: 'content/ui/popup-in-page.html', c: 'Security/AV' },
    { n: 'Trend Micro Check', id: 'imhhfjfjfhjjjgaedcanngoffjmcblgi', f: '_locales/de/adblock.json', c: 'Security/AV' },
    // ‚îÄ‚îÄ‚îÄ Auth / SSO
    { n: 'OneLogin', id: 'ioalpmibngobedobkmbhgmajpcfbgbhl', f: 'ui/saveNewAppDialog.html', c: 'Auth/SSO' },
    { n: 'Microsoft Autofill', id: 'fiedbfgcleddlbcmgdigjgdfcggjcion', f: 'microsoftAutofill.html', c: 'Auth/SSO' },
    // ‚îÄ‚îÄ‚îÄ Communication
    { n: 'Cisco Webex', id: 'jlhmfgmfgeifomenelglieieghnjghma', f: 'cwcsf-nativemsg-iframe-43c85c0d-d633-af5e-c056-32dc7efc570b.html', c: 'Communication' },
    { n: 'Zoom Scheduler', id: 'kgjfgplpablkjnlkjmjdecgdpfankdle', f: 'images/loading_24.gif', c: 'Communication' },
    // ‚îÄ‚îÄ‚îÄ Tools / Misc
    { n: 'Adobe Acrobat', id: 'efaidnbmnnnibpcajpcglclefindmkaj', f: 'viewer.html', c: 'Tools' },
    { n: 'ColorZilla', id: 'bhlhnicpbhignbdhedgjhgdocnmhomnp', f: 'css/content-style.css', c: 'Tools' },
    { n: 'ColorPick Eyedropper', id: 'ohcpnigalekghcmgcdcenkpelffpdolg', f: 'img/icon16.png', c: 'Tools' },
    { n: 'Mercury Reader', id: 'oknpjjbmpnndlpmnhmekjpocelpnlfdi', f: 'app.html', c: 'Tools' },
    { n: 'Email Tracker (Mailtrack)', id: 'ndnaehgpjlnokgebbaldlmgkapkpjkkb', f: 'images/mailtrack-crx-sprite_2x.png', c: 'Tools' },
    { n: 'Hunter Email Finder', id: 'hgmhmanijnjhaffoampdlllchpolkdnj', f: 'html/source_popup.html', c: 'Tools' },
    { n: 'Kami for Google Chrome', id: 'ecnphlgnajanjnkcmbpancdjoidceilk', f: 'content/web/options.html', c: 'Tools' },
    { n: 'Avast SafePrice', id: 'eofcbnmajmjmplflapaojjnihcjkigck', f: 'common/ui/css/extension.css', c: 'Tools' },
  ];

  // Protected extensions: use timing comparison (fetch race vs non-existent ID)
  // These use randomized tokens or strict origin checks ‚Äî direct fetch returns same error
  const PROTECTED = [
    { n: 'uBlock Origin', id: 'cjpalhdlnbpafiamejdnhcphjbkeiagm', f: 'web_accessible_resources/noop.html', c: 'Ad Blockers' },
    { n: 'AdGuard AdBlocker', id: 'bgnkhhnnamicmpeenaelnjfhikgbkllg', f: 'web-accessible-resources/redirects/1x1-transparent.gif', c: 'Ad Blockers' },
    { n: 'Privacy Badger', id: 'pkehgijcmpdhfbdbbnkijodmdjhbjlgp', f: 'data/web_accessible_resources/README.md', c: 'Privacy/VPN' },
    { n: 'Decentraleyes', id: 'ldpochfccmkkmhdbclfhpagapcfdljkj', f: 'resources/webfont/1.5.6/webfont.jsm', c: 'Privacy/VPN' },
    { n: 'Okta Browser Plugin', id: 'glnpjglilkicbckjpbgcfkogebgllemb', f: 'getFrameId', c: 'Auth/SSO' },
  ];

  const isChromium = !!window.chrome || navigator.userAgent.includes('Chrome') || navigator.userAgent.includes('Edg');

  if (!isChromium) {
    setBody('extfp', [
      row('Browser Support', '<span class="warn">Firefox randomizes extension IDs ‚Äî chrome-extension:// probing unavailable</span>'),
      row('Note', 'Window global checks still apply (MetaMask, Phantom)'),
    ].join(''));
    collected.extensions = { count: 0, hash: 'N/A', names: [], supported: false };
    markDone('extfp', false);
    return;
  }

  setBody('extfp', row('Status', `<span class="loading">Probing ${EXT.length} extensions in parallel...</span>`));

  // Regular probe ‚Äî all in parallel
  const detected = [];
  try {
    const probeResults = await Promise.all(
      EXT.map(ext =>
        fetch(`chrome-extension://${ext.id}/${ext.f}`)
          .then(() => ({ ...ext, found: true, method: 'fetch' }))
          .catch(() => ({ ...ext, found: false }))
      )
    );
    for (const r of probeResults) if (r.found) detected.push(r);
  } catch(e) {}

  // Timing probe for protected extensions (20 iterations each)
  setBody('extfp', row('Status', `<span class="loading">Timing probe for ${PROTECTED.length} protected extensions...</span>`));
  const DUMMY = 'pmlfbbehleledmbphnielafhieceggal';
  const tfetch = async (url) => { const t = performance.now(); try { await fetch(url); } catch(e) {} return performance.now() - t; };
  for (const ext of PROTECTED) {
    try {
      const url = `chrome-extension://${ext.id}/${ext.f}`;
      const fakeUrl = `chrome-extension://${DUMMY}/${ext.f}`;
      let hits = 0, iters = 20;
      for (let i = 0; i < iters; i++) {
        const d1 = await tfetch(url);
        const d2 = await tfetch(fakeUrl);
        if (d1 > d2) hits++;
      }
      if (hits / iters > 0.6) detected.push({ ...ext, found: true, method: 'timing' });
    } catch(e) {}
  }

  // Window global checks for extensions that expose no resources
  try {
    if (typeof window.ethereum !== 'undefined' && !navigator.brave)
      detected.push({ n: 'MetaMask', id: 'nkbihfbeogaeaoehlefnkodbefgpgknn', c: 'Crypto/Web3', method: 'window.ethereum' });
  } catch(e) {}
  try {
    if (typeof window.solana !== 'undefined')
      detected.push({ n: 'Phantom (Solana)', id: 'bfnaelmomeimhlpmgjnjophhpkkoljpa', c: 'Crypto/Web3', method: 'window.solana' });
  } catch(e) {}

  // Build fingerprint hash from sorted detected IDs
  const detectedIds = detected.map(e => e.id).sort();
  const hash = detectedIds.length ? await simpleHash(detectedIds.join(',')) : 'none';
  collected.extensions = { count: detected.length, hash, names: detected.map(e => e.n), supported: true };

  // Group by category for display
  const byCat = {};
  for (const e of detected) {
    const c = e.c || 'Other';
    if (!byCat[c]) byCat[c] = [];
    byCat[c].push(e);
  }

  const catRows = [];
  for (const [cat, exts] of Object.entries(byCat)) {
    catRows.push(`<div style="color:var(--dim);font-size:10px;padding:3px 0 1px;letter-spacing:1px;text-transform:uppercase">${cat}</div>`);
    for (const e of exts) {
      const methodBadge = e.method === 'timing' ? ` <span style="color:var(--dim);font-size:10px">[timing]</span>` :
                          e.method ? ` <span style="color:var(--dim);font-size:10px">[${e.method}]</span>` : '';
      catRows.push(`<div class="data-row" style="padding:2px 0"><span class="data-key" style="color:var(--dim);min-width:110px;font-size:10px">${e.id.substring(0,8)}‚Ä¶</span><span class="data-val highlight">${e.n}${methodBadge}</span></div>`);
    }
  }

  const noDetect = detected.length === 0
    ? `<div style="color:var(--dim);font-style:italic;padding:6px 0">No detectable extensions found. Extensions using dynamic URLs (MV3) cannot be detected.</div>`
    : '';

  setBody('extfp', [
    row('Probed (fetch)', `${EXT.length} extensions`),
    row('Probed (timing)', `${PROTECTED.length} protected extensions`),
    row('Probed (globals)', '2 (MetaMask, Phantom)'),
    row('Detected', `<span class="${detected.length > 0 ? 'highlight' : 'dim'}">${detected.length} extension${detected.length !== 1 ? 's' : ''}</span>`),
    row('Extension Hash', `<span class="highlight">${hash}</span>`),
    detected.length > 0
      ? `<div style="border-top:1px solid var(--border);margin-top:6px;padding-top:6px">${catRows.join('')}</div>`
      : noDetect,
  ].join(''));

  markDone('extfp');
}

// ‚îÄ‚îÄ‚îÄ Utility ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function simpleHash(str) {
  try {
    const data = new TextEncoder().encode(String(str));
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).slice(0,8).map(b => b.toString(16).padStart(2,'0')).join('');
  } catch(e) {
    let h = 0;
    for (let i = 0; i < str.length; i++) { h = ((h << 5) - h) + str.charCodeAt(i); h |= 0; }
    return Math.abs(h).toString(16).padStart(8,'0');
  }
}

// ‚îÄ‚îÄ‚îÄ Summary builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function buildSummary() {
  setStatus('Building fingerprint summary...');

  const summaryData = [
    ['Browser', `${collected.browser?.browser} ${collected.browser?.version}`, 'HI'],
    ['Engine', collected.browser?.engine || 'N/A', 'HI'],
    ['User Agent', (collected.browser?.ua || '').substring(0, 80) + '...', 'HI'],
    ['Screen Resolution', `${collected.screen?.width}√ó${collected.screen?.height}`, 'HI'],
    ['Physical Resolution', `${Math.round(collected.screen?.width*collected.screen?.dpr)}√ó${Math.round(collected.screen?.height*collected.screen?.dpr)}`, 'HI'],
    ['Device Pixel Ratio', collected.screen?.dpr, 'WARN'],
    ['Color Depth', collected.screen?.colorDepth + '-bit', 'OK'],
    ['CPU Cores', collected.hw?.cores, 'HI'],
    ['Device Memory', collected.hw?.mem !== 'N/A' ? collected.hw?.mem + ' GB' : 'Blocked', collected.hw?.mem !== 'N/A' ? 'HI' : 'OK'],
    ['GPU', (collected.hw?.gpu || 'N/A').substring(0,50), 'HI'],
    ['Touch Points', collected.hw?.touch, 'WARN'],
    ['Timezone', collected.locale?.tz, 'HI'],
    ['Languages', collected.locale?.locales, 'HI'],
    ['Connection Type', collected.network?.effType, 'WARN'],
    ['WebRTC Local IP', collected.network?.localIPs?.length ? collected.network.localIPs.join(', ') : 'Not leaked', collected.network?.localIPs?.length ? 'HI' : 'OK'],
    ['Canvas Hash', collected.canvas?.hash, 'HI'],
    ['Audio Hash', collected.audio?.audioFP, 'HI'],
    ['Audio Sample Rate', collected.audio?.sampleRate + ' Hz', 'WARN'],
    ['Fonts Detected', collected.fonts?.count + ' fonts', 'HI'],
    ['Battery Level', collected.battery ? collected.battery.level + '%' : 'N/A', collected.battery ? 'WARN' : 'OK'],
    ['Microphones', collected.media?.audioIn + ' device(s)', collected.media?.audioIn > 0 ? 'WARN' : 'OK'],
    ['Cameras', collected.media?.videoIn + ' device(s)', collected.media?.videoIn > 0 ? 'WARN' : 'OK'],
    ['WebRTC Support', collected.webrtc?.supported ? 'Yes' : 'No', collected.webrtc?.supported ? 'HI' : 'OK'],
    ['Cookies Enabled', navigator.cookieEnabled ? 'Yes' : 'No', navigator.cookieEnabled ? 'WARN' : 'OK'],
    ['Do Not Track', navigator.doNotTrack || 'Not set', 'OK'],
    ['CPU Benchmark', collected.perf?.cpuTime + 'ms', 'WARN'],
    ['JS Heap', collected.perf?.heapUsed ? collected.perf.heapUsed + ' MB' : 'N/A', 'WARN'],
    ['Speech Voices', collected.voices ? `${collected.voices.count} voices / hash:${collected.voices.hash}` : 'N/A', 'HI'],
    ['JS Engine Hash', collected.jsprec?.hash || 'N/A', 'HI'],
    ['Scrollbar Width', (collected.cssrender?.scrollbarW ?? 'N/A') + 'px (reveals OS/theme)', 'WARN'],
    ['WebGL Extensions', collected.webgldp ? `${collected.webgldp.extCount} exts / hash:${collected.webgldp.extHash}` : 'N/A', 'HI'],
    ['Private Mode', collected.privmode?.verdict || 'N/A', collected.privmode?.suspiciousCount >= 3 ? 'HI' : collected.privmode?.suspiciousCount >= 1 ? 'WARN' : 'OK'],
    ['NAT Type', collected.natinfo?.natType || 'N/A', 'HI'],
    ['WebRTC Public IP', collected.natinfo?.publicIP || 'Not leaked', collected.natinfo?.publicIP ? 'HI' : 'OK'],
    ['WASM Support', collected.wasm ? `${collected.wasm.supportedCount} / 5 features` : 'N/A', 'WARN'],
    ['CPU Bench Score', collected.benchmarks?.intOps ? Number(collected.benchmarks.intOps).toLocaleString() + ' ops/ms' : 'N/A', 'WARN'],
    ['GPU Bench Score', collected.benchmarks?.gpuFill ? collected.benchmarks.gpuFill + ' Mpix/s' : 'N/A', 'WARN'],
    ['First Interaction', collected.behavior?.modality ? `${collected.behavior.modality} @ ${collected.behavior.firstInteraction}ms` : 'No interaction detected', 'WARN'],
    ['Extensions Detected', collected.extensions?.supported === false ? 'N/A (Firefox)' : `${collected.extensions?.count ?? 0} detected / hash:${collected.extensions?.hash ?? 'N/A'}`, collected.extensions?.count > 0 ? 'HI' : 'OK'],
  ];

  const tbody = document.getElementById('summary-body');
  tbody.innerHTML = summaryData.map(([key, val, risk]) => {
    const badge = risk === 'HI' ? '<span class="badge badge-hi">HIGH</span>' :
                  risk === 'WARN' ? '<span class="badge badge-warn">MED</span>' :
                  risk === 'OK' ? '<span class="badge badge-ok">LOW</span>' :
                  '<span class="badge badge-na">N/A</span>';
    return `<tr><td>${key}</td><td>${val ?? 'N/A'}</td><td>${badge}</td></tr>`;
  }).join('');

  // Fingerprint hash
  const fpStr = JSON.stringify(collected);
  const globalHash = await simpleHash(fpStr);
  document.getElementById('fingerprint-hash').textContent = `SHA-256: ${globalHash}`;

  // Risk score
  const hiCount = summaryData.filter(d => d[2] === 'HI').length;
  const total = summaryData.length;
  const score = Math.round((hiCount / total) * 100);
  const scoreEl = document.getElementById('risk-score');
  const color = score > 70 ? 'var(--accent2)' : score > 40 ? 'var(--warn)' : 'var(--accent3)';
  scoreEl.innerHTML = `
    <div style="font-size:11px;color:var(--dim);letter-spacing:3px;margin-bottom:8px;font-family:'Share Tech Mono'">FINGERPRINT IDENTIFIABILITY SCORE</div>
    <span style="color:${color};text-shadow:0 0 20px ${color}">${score}%</span>
    <div style="font-size:11px;color:var(--text);letter-spacing:1px;margin-top:8px;font-family:'Share Tech Mono'">${hiCount} HIGH-ENTROPY VECTORS DETECTED</div>
  `;

  document.getElementById('summary').style.display = 'block';
  document.getElementById('scan-duration').textContent = `SCAN COMPLETED IN ${((Date.now()-startTime)/1000).toFixed(2)}s`;
}

// ‚îÄ‚îÄ‚îÄ Main orchestrator ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function runScan() {
  const steps = [
    collectBrowser,
    collectScreen,
    collectHardware,
    collectLocale,
    collectStorage,
    collectFonts,
    collectWebRTC,
    () => collectNetwork(),
    () => collectPerformance(),
    () => collectCanvas(),
    () => collectAudio(),
    () => collectBattery(),
    () => collectPermissions(),
    () => collectMediaDevices(),
    () => collectVoices(),
    () => collectJSPrecision(),
    () => collectCSSRender(),
    () => collectWebGLDeep(),
    () => collectPrivMode(),
    () => collectNATInfo(),
    () => collectWASM(),
    () => collectBehavior(),
    () => collectExtensions(),
    () => runBenchmarks(),
  ];

  totalSteps = steps.length;

  for (const step of steps) {
    try { await step(); } catch(e) { console.error(e); }
    await new Promise(r => setTimeout(r, 60));
  }

  setProgress(100);
  setStatus('‚úì Scan complete ‚Äî generating fingerprint summary...');
  document.querySelector('.status-dot').style.background = 'var(--accent3)';
  document.querySelector('.status-dot').style.animation = 'none';

  await new Promise(r => setTimeout(r, 400));
  await buildSummary();
  setStatus('‚úì Fingerprint analysis complete. ' + Object.keys(collected).length + ' data vectors collected.');
}

runScan();
</script>
</body>
</html>